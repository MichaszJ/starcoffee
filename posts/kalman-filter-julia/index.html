<!doctype html> <html lang=en > <meta charset=UTF-8 > <meta name=viewport  content="width=device-width, initial-scale=1"> <link rel=preconnect  href="https://fonts.googleapis.com"> <link rel=preconnect  href="https://fonts.gstatic.com" crossorigin> <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;700&display=swap" rel=stylesheet > <link rel=stylesheet  href="/starcoffee/libs/katex/katex.min.css"> <link rel=stylesheet  href="/starcoffee/libs/highlight/styles/github.min.css"> <link rel=stylesheet  href="/starcoffee/css/franklin.css"> <link rel=stylesheet  href="/starcoffee/css/poole_lanyon.css"> <link rel=stylesheet  href="/starcoffee/css/adjust.css"> <link rel=icon  href="/starcoffee/assets/favicon.png"> <title>Implementing a Linear Kalman Filter in Julia</title> <input type=checkbox  class=sidebar-checkbox  id=sidebar-checkbox > <div class=sidebar  id=sidebar > <div class=sidebar-item > <p>Star Coffee</p> </div> <nav class=sidebar-nav > <a class="sidebar-nav-item " href="/starcoffee/">Home</a> <a class="sidebar-nav-item " href="/starcoffee/posts/welcome-to-star-coffee/">Welcome to Star Coffee</a> <a class="sidebar-nav-item " href="/starcoffee/posts/projects/">Projects</a> <a class="sidebar-nav-item " href="/starcoffee/posts/satellite-analysis-toolkit/">Satellite Analysis Toolkit</a> <a class="sidebar-nav-item " href="/starcoffee/posts/simple-nn/">Simple NN</a> </nav> <div class=sidebar-item > <p>&copy; Michal Jagodzinski.</p> </div> </div> <!-- Wrap is the content to shift when toggling the sidebar. We wrap the content to avoid any CSS collisions with our real content. --> <div class=wrap > <div class=masthead > <div class=container > <h3 class=masthead-title > <a href="/starcoffee/" title=Home >Star Coffee</a> <small>Writing about stuff, working in public</small> </h3> </div> </div> <div class="container content"> <div class=franklin-content ><div class=title-section><p class=post-title>Implementing a Linear Kalman Filter in Julia</p><div class=tags-section><a href=/starcoffee/tag/blogging class=tag>Blogging</a><a href=/starcoffee/tag/programming class=tag>Programming</a><a href=/starcoffee/tag/julia class=tag>Julia</a><a href=/starcoffee/tag/aerospace class=tag>Aerospace</a></div><p class=post-subtitle>Implementing the linear Kalman filter for state estimation in Julia</p><div class=metadata-section><div class=metadata>Author<p>Michal Jagodzinski</p></div><div class=metadata>Published<p>September 3rd, 2023</p></div></div></div> <div class=im-60 ><img src="https://source.unsplash.com/UM6icC4s4gQ" alt="" /></div> <div class=img-caption >Photo by <a href="https://unsplash.com/photos/UM6icC4s4gQ">Daniel J. Schwarz</a></div> <div class=franklin-toc ><ol><li><a href="#introduction_to_the_kalman_filter">Introduction to the Kalman Filter</a><ol><li><a href="#state_estimation">State Estimation</a><li><a href="#the_kalman_filter_algorithm">The Kalman Filter Algorithm</a></ol><li><a href="#kalman_filter_implementation">Kalman Filter Implementation</a><li><a href="#running_a_simple_tracking_simulation">Running a Simple Tracking Simulation</a><li><a href="#conclusion">Conclusion</a><li><a href="#references">References</a></ol></div> <h1 id=introduction_to_the_kalman_filter ><a href="#introduction_to_the_kalman_filter" class=header-anchor >Introduction to the Kalman Filter</a></h1> <h2 id=state_estimation ><a href="#state_estimation" class=header-anchor >State Estimation</a></h2> <p>As implied by the term, <a href="https://www.nasa.gov/centers/ames/research/technology-onepagers/state-estimation.html">state estimation</a> involves using models and data to estimate the state of a system. State usually involves useful quantities of systems such as position, velocity, attitude, etc. </p> <p>The linear Kalman filter and its other forms are very commonly used in the aerospace field for state estimation applications. If you&#39;re interested in the aerospace GN&amp;C field like me, understanding state estimation and Kalman filters is essential.</p> <h2 id=the_kalman_filter_algorithm ><a href="#the_kalman_filter_algorithm" class=header-anchor >The Kalman Filter Algorithm</a></h2> <p>I am not going to go in depth on the theory, math, derivation, etc. behind the Kalman filter. If you&#39;d like to learn more in detail, I highly recommend checking out <a href="https://github.com/rlabbe/Kalman-and-Bayesian-Filters-in-Python">Kalman and Bayesian Filters in Python</a>, a great free book that delves into derivation and theory of Kalman filters.</p> <p>The Kalman filter works by representing the state&#40;s&#41; of our system with <a href="https://en.wikipedia.org/wiki/Normal_distribution">Gaussian distributions</a>. A Gaussian distribution is defined by two parameters, a mean, and a variance &#40;or standard deviation&#41;. Essentially, we are defining each state of a system with some level of uncertainty.</p> <div class=im-100 ><img src="/starcoffee/assets/posts/kalman-filter-julia/code/gaussian_fig.svg" alt=""></div> <div class=img-caption >Some probability density functions of Gaussian distributions with varying means <span class=katex ><span class=katex-mathml ><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>μ</mi></mrow><annotation encoding="application/x-tex">\mu</annotation></semantics></math></span><span class=katex-html  aria-hidden=true ><span class=base ><span class=strut  style="height:0.625em;vertical-align:-0.1944em;"></span><span class="mord mathnormal">μ</span></span></span></span> and standard deviations <span class=katex ><span class=katex-mathml ><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>σ</mi></mrow><annotation encoding="application/x-tex">\sigma</annotation></semantics></math></span><span class=katex-html  aria-hidden=true ><span class=base ><span class=strut  style="height:0.4306em;"></span><span class="mord mathnormal" style="margin-right:0.03588em;">σ</span></span></span></span>.</div> <p>The Kalman filter algorithm has two distinct steps, prediction and correction. The filter first predicts the state of the system after a discrete timestep <span class=katex ><span class=katex-mathml ><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi mathvariant=normal >Δ</mi><mi>t</mi></mrow><annotation encoding="application/x-tex">\Delta t</annotation></semantics></math></span><span class=katex-html  aria-hidden=true ><span class=base ><span class=strut  style="height:0.6833em;"></span><span class=mord >Δ</span><span class="mord mathnormal">t</span></span></span></span>. It then uses a measurement of the system at that time to correct that prediction and give a more accurate &#40;accurate meaning less variance of the Gaussian&#41; prediction of the true state of the system.</p> <div class=im-100 ><img src="/starcoffee/assets/posts/kalman-filter-julia/code/kf-fig1.svg" alt=""></div> <p>Obviously every mathematical model used to generate the prediction and the sensors used to measure the state&#40;s&#41; of the system contain noise. Noise is a simple fact of life. However, by combining these two distinct sources of information, the Kalman filter provides a much more accurate estimate of the state than each individual data point. We can think of the predictions <span class=katex ><span class=katex-mathml ><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mover accent=true ><mi>x</mi><mo>ˉ</mo></mover></mrow><annotation encoding="application/x-tex">\bar x</annotation></semantics></math></span><span class=katex-html  aria-hidden=true ><span class=base ><span class=strut  style="height:0.5678em;"></span><span class="mord accent"><span class=vlist-t ><span class=vlist-r ><span class=vlist  style="height:0.5678em;"><span style="top:-3em;"><span class=pstrut  style="height:3em;"></span><span class="mord mathnormal">x</span></span><span style="top:-3em;"><span class=pstrut  style="height:3em;"></span><span class=accent-body  style="left:-0.2222em;"><span class=mord >ˉ</span></span></span></span></span></span></span></span></span></span> and measurements <span class=katex ><span class=katex-mathml ><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>z</mi></mrow><annotation encoding="application/x-tex">z</annotation></semantics></math></span><span class=katex-html  aria-hidden=true ><span class=base ><span class=strut  style="height:0.4306em;"></span><span class="mord mathnormal" style="margin-right:0.04398em;">z</span></span></span></span> as areas where the true state of the system can exist within. Using these two values we can assume that the true state must lie somewhere between these two values:</p> <div class=im-50 ><img src="/starcoffee/assets/posts/kalman-filter-julia/code/kf-fig2.svg" alt=""></div> <p>As you can clearly see, the true trajectory must reside within the intersection of <span class=katex ><span class=katex-mathml ><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mover accent=true ><mi>x</mi><mo>ˉ</mo></mover></mrow><annotation encoding="application/x-tex">\bar x</annotation></semantics></math></span><span class=katex-html  aria-hidden=true ><span class=base ><span class=strut  style="height:0.5678em;"></span><span class="mord accent"><span class=vlist-t ><span class=vlist-r ><span class=vlist  style="height:0.5678em;"><span style="top:-3em;"><span class=pstrut  style="height:3em;"></span><span class="mord mathnormal">x</span></span><span style="top:-3em;"><span class=pstrut  style="height:3em;"></span><span class=accent-body  style="left:-0.2222em;"><span class=mord >ˉ</span></span></span></span></span></span></span></span></span></span> and <span class=katex ><span class=katex-mathml ><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>z</mi></mrow><annotation encoding="application/x-tex">z</annotation></semantics></math></span><span class=katex-html  aria-hidden=true ><span class=base ><span class=strut  style="height:0.4306em;"></span><span class="mord mathnormal" style="margin-right:0.04398em;">z</span></span></span></span>, and that this intersection is a much smaller possible area than either <span class=katex ><span class=katex-mathml ><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mover accent=true ><mi>x</mi><mo>ˉ</mo></mover></mrow><annotation encoding="application/x-tex">\bar x</annotation></semantics></math></span><span class=katex-html  aria-hidden=true ><span class=base ><span class=strut  style="height:0.5678em;"></span><span class="mord accent"><span class=vlist-t ><span class=vlist-r ><span class=vlist  style="height:0.5678em;"><span style="top:-3em;"><span class=pstrut  style="height:3em;"></span><span class="mord mathnormal">x</span></span><span style="top:-3em;"><span class=pstrut  style="height:3em;"></span><span class=accent-body  style="left:-0.2222em;"><span class=mord >ˉ</span></span></span></span></span></span></span></span></span></span> or <span class=katex ><span class=katex-mathml ><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>z</mi></mrow><annotation encoding="application/x-tex">z</annotation></semantics></math></span><span class=katex-html  aria-hidden=true ><span class=base ><span class=strut  style="height:0.4306em;"></span><span class="mord mathnormal" style="margin-right:0.04398em;">z</span></span></span></span> on their own. Here lies the power of the Kalman filter, combining information about the state in the prediction step and using measurements to update that prediction results in a significantly more accurate estimate of the true value of the state.</p> <div class=im-100 ><img src="/starcoffee/assets/posts/kalman-filter-julia/code/gaussian_fig2.svg" alt=""></div> <div class=img-caption >Combining the prediction and measurement Gaussians provides an updated estimate of the state with lower variances/higher accuracy.</div> <p>Assuming a general multivariate system, starting with the state mean <span class=katex ><span class=katex-mathml ><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi mathvariant=bold >x</mi></mrow><annotation encoding="application/x-tex">\mathbf x</annotation></semantics></math></span><span class=katex-html  aria-hidden=true ><span class=base ><span class=strut  style="height:0.4444em;"></span><span class="mord mathbf">x</span></span></span></span> and covariance matrix <span class=katex ><span class=katex-mathml ><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi mathvariant=bold >P</mi></mrow><annotation encoding="application/x-tex">\mathbf P</annotation></semantics></math></span><span class=katex-html  aria-hidden=true ><span class=base ><span class=strut  style="height:0.6861em;"></span><span class="mord mathbf">P</span></span></span></span>, the prediction step is defined as:</p> <span class=katex-display ><span class=katex ><span class=katex-mathml ><math xmlns="http://www.w3.org/1998/Math/MathML" display=block ><semantics><mtable rowspacing=0.25em  columnalign="right left" columnspacing=0em ><mtr><mtd><mstyle scriptlevel=0  displaystyle=true ><mover accent=true ><mtext mathvariant=bold >x</mtext><mo>ˉ</mo></mover></mstyle></mtd><mtd><mstyle scriptlevel=0  displaystyle=true ><mrow><mrow></mrow><mo>=</mo><mtext mathvariant=bold >Fx</mtext><mo>+</mo><mtext mathvariant=bold >Bu</mtext></mrow></mstyle></mtd></mtr><mtr><mtd><mstyle scriptlevel=0  displaystyle=true ><mover accent=true ><mtext mathvariant=bold >P</mtext><mo>ˉ</mo></mover></mstyle></mtd><mtd><mstyle scriptlevel=0  displaystyle=true ><mrow><mrow></mrow><mo>=</mo><msup><mtext mathvariant=bold >FPF</mtext><mo>⊺</mo></msup><mo>+</mo><mtext mathvariant=bold >Q</mtext></mrow></mstyle></mtd></mtr></mtable><annotation encoding="application/x-tex"> \begin{aligned} \bar{\textbf x} &amp;= \textbf{F} \textbf x + \textbf B \textbf u \\ \bar{\textbf P} &amp;= \textbf{FPF}^\intercal + \textbf Q \end{aligned} </annotation></semantics></math></span><span class=katex-html  aria-hidden=true ><span class=base ><span class=strut  style="height:3em;vertical-align:-1.25em;"></span><span class=mord ><span class=mtable ><span class=col-align-r ><span class="vlist-t vlist-t2"><span class=vlist-r ><span class=vlist  style="height:1.75em;"><span style="top:-3.91em;"><span class=pstrut  style="height:3em;"></span><span class=mord ><span class="mord accent"><span class=vlist-t ><span class=vlist-r ><span class=vlist  style="height:0.5812em;"><span style="top:-3em;"><span class=pstrut  style="height:3em;"></span><span class="mord text"><span class="mord textbf">x</span></span></span><span style="top:-3.0134em;"><span class=pstrut  style="height:3em;"></span><span class=accent-body  style="left:-0.25em;"><span class=mord >ˉ</span></span></span></span></span></span></span></span></span><span style="top:-2.41em;"><span class=pstrut  style="height:3em;"></span><span class=mord ><span class="mord accent"><span class=vlist-t ><span class=vlist-r ><span class=vlist  style="height:0.8229em;"><span style="top:-3em;"><span class=pstrut  style="height:3em;"></span><span class="mord text"><span class="mord textbf">P</span></span></span><span style="top:-3.2551em;"><span class=pstrut  style="height:3em;"></span><span class=accent-body  style="left:-0.25em;"><span class=mord >ˉ</span></span></span></span></span></span></span></span></span></span><span class=vlist-s >​</span></span><span class=vlist-r ><span class=vlist  style="height:1.25em;"><span></span></span></span></span></span><span class=col-align-l ><span class="vlist-t vlist-t2"><span class=vlist-r ><span class=vlist  style="height:1.75em;"><span style="top:-3.91em;"><span class=pstrut  style="height:3em;"></span><span class=mord ><span class=mord ></span><span class=mspace  style="margin-right:0.2778em;"></span><span class=mrel >=</span><span class=mspace  style="margin-right:0.2778em;"></span><span class="mord text"><span class="mord textbf">F</span></span><span class="mord text"><span class="mord textbf">x</span></span><span class=mspace  style="margin-right:0.2222em;"></span><span class=mbin >+</span><span class=mspace  style="margin-right:0.2222em;"></span><span class="mord text"><span class="mord textbf">B</span></span><span class="mord text"><span class="mord textbf">u</span></span></span></span><span style="top:-2.41em;"><span class=pstrut  style="height:3em;"></span><span class=mord ><span class=mord ></span><span class=mspace  style="margin-right:0.2778em;"></span><span class=mrel >=</span><span class=mspace  style="margin-right:0.2778em;"></span><span class=mord ><span class="mord text"><span class="mord textbf">FPF</span></span><span class=msupsub ><span class=vlist-t ><span class=vlist-r ><span class=vlist  style="height:0.7404em;"><span style="top:-3.139em;margin-right:0.05em;"><span class=pstrut  style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mbin amsrm mtight">⊺</span></span></span></span></span></span></span></span><span class=mspace  style="margin-right:0.2222em;"></span><span class=mbin >+</span><span class=mspace  style="margin-right:0.2222em;"></span><span class="mord text"><span class="mord textbf">Q</span></span></span></span></span><span class=vlist-s >​</span></span><span class=vlist-r ><span class=vlist  style="height:1.25em;"><span></span></span></span></span></span></span></span></span></span></span></span> <p>Where <span class=katex ><span class=katex-mathml ><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mtext mathvariant=bold >x</mtext></mrow><annotation encoding="application/x-tex">\textbf x</annotation></semantics></math></span><span class=katex-html  aria-hidden=true ><span class=base ><span class=strut  style="height:0.4444em;"></span><span class="mord text"><span class="mord textbf">x</span></span></span></span></span>, <span class=katex ><span class=katex-mathml ><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mtext mathvariant=bold >P</mtext></mrow><annotation encoding="application/x-tex">\textbf P</annotation></semantics></math></span><span class=katex-html  aria-hidden=true ><span class=base ><span class=strut  style="height:0.6861em;"></span><span class="mord text"><span class="mord textbf">P</span></span></span></span></span> are the state mean and <a href="https://en.wikipedia.org/wiki/Covariance_matrix">covariance matrix</a>, <span class=katex ><span class=katex-mathml ><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mtext mathvariant=bold >F</mtext></mrow><annotation encoding="application/x-tex">\textbf F</annotation></semantics></math></span><span class=katex-html  aria-hidden=true ><span class=base ><span class=strut  style="height:0.6861em;"></span><span class="mord text"><span class="mord textbf">F</span></span></span></span></span> is the state transition matrix, <span class=katex ><span class=katex-mathml ><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mtext mathvariant=bold >Q</mtext></mrow><annotation encoding="application/x-tex">\textbf Q</annotation></semantics></math></span><span class=katex-html  aria-hidden=true ><span class=base ><span class=strut  style="height:0.8805em;vertical-align:-0.1944em;"></span><span class="mord text"><span class="mord textbf">Q</span></span></span></span></span> is the process covariance, and <span class=katex ><span class=katex-mathml ><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mtext mathvariant=bold >B</mtext></mrow><annotation encoding="application/x-tex">\textbf B</annotation></semantics></math></span><span class=katex-html  aria-hidden=true ><span class=base ><span class=strut  style="height:0.6861em;"></span><span class="mord text"><span class="mord textbf">B</span></span></span></span></span>, <span class=katex ><span class=katex-mathml ><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mtext mathvariant=bold >u</mtext></mrow><annotation encoding="application/x-tex">\textbf u</annotation></semantics></math></span><span class=katex-html  aria-hidden=true ><span class=base ><span class=strut  style="height:0.4444em;"></span><span class="mord text"><span class="mord textbf">u</span></span></span></span></span> are the control inputs to the system &#40;if control inputs are applied&#41;.</p> <p>Next, given a vector of measurements <span class=katex ><span class=katex-mathml ><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi mathvariant=bold >z</mi></mrow><annotation encoding="application/x-tex">\mathbf z</annotation></semantics></math></span><span class=katex-html  aria-hidden=true ><span class=base ><span class=strut  style="height:0.4444em;"></span><span class="mord mathbf">z</span></span></span></span>, the update step is defined as:</p> <span class=katex-display ><span class=katex ><span class=katex-mathml ><math xmlns="http://www.w3.org/1998/Math/MathML" display=block ><semantics><mtable rowspacing=0.25em  columnalign="right left" columnspacing=0em ><mtr><mtd><mstyle scriptlevel=0  displaystyle=true ><mtext mathvariant=bold >y</mtext></mstyle></mtd><mtd><mstyle scriptlevel=0  displaystyle=true ><mrow><mrow></mrow><mo>=</mo><mtext mathvariant=bold >z</mtext><mo>−</mo><mtext mathvariant=bold >H</mtext><mover accent=true ><mtext mathvariant=bold >x</mtext><mo>ˉ</mo></mover></mrow></mstyle></mtd></mtr><mtr><mtd><mstyle scriptlevel=0  displaystyle=true ><mtext mathvariant=bold >K</mtext></mstyle></mtd><mtd><mstyle scriptlevel=0  displaystyle=true ><mrow><mrow></mrow><mo>=</mo><mover accent=true ><mtext mathvariant=bold >P</mtext><mo>ˉ</mo></mover><msup><mtext mathvariant=bold >H</mtext><mo>⊺</mo></msup><mo stretchy=false >(</mo><mtext mathvariant=bold >H</mtext><mover accent=true ><mtext mathvariant=bold >P</mtext><mo>ˉ</mo></mover><msup><mtext mathvariant=bold >H</mtext><mo>⊺</mo></msup><mo>+</mo><mtext mathvariant=bold >R</mtext><msup><mo stretchy=false >)</mo><mrow><mo>−</mo><mn>1</mn></mrow></msup></mrow></mstyle></mtd></mtr><mtr><mtd><mstyle scriptlevel=0  displaystyle=true ><mtext mathvariant=bold >x</mtext></mstyle></mtd><mtd><mstyle scriptlevel=0  displaystyle=true ><mrow><mrow></mrow><mo>=</mo><mover accent=true ><mtext mathvariant=bold >x</mtext><mo>ˉ</mo></mover><mo>+</mo><mtext mathvariant=bold >Ky</mtext></mrow></mstyle></mtd></mtr><mtr><mtd><mstyle scriptlevel=0  displaystyle=true ><mtext mathvariant=bold >P</mtext></mstyle></mtd><mtd><mstyle scriptlevel=0  displaystyle=true ><mrow><mrow></mrow><mo>=</mo><mo stretchy=false >(</mo><mtext mathvariant=bold >I</mtext><mo>−</mo><mtext mathvariant=bold >KH</mtext><mo stretchy=false >)</mo><mover accent=true ><mtext mathvariant=bold >P</mtext><mo>ˉ</mo></mover></mrow></mstyle></mtd></mtr></mtable><annotation encoding="application/x-tex"> \begin{aligned} \textbf y &amp;= \textbf z - \textbf H \bar{\textbf x} \\ \textbf K &amp;= \bar{\textbf P} \textbf H^\intercal (\textbf H \bar{\textbf P} \textbf H^\intercal + \textbf R)^{-1} \\ \textbf x &amp;= \bar{\textbf x} + \textbf K \textbf y \\ \textbf P &amp;= (\textbf I - \textbf K \textbf H) \bar{\textbf P} \end{aligned} </annotation></semantics></math></span><span class=katex-html  aria-hidden=true ><span class=base ><span class=strut  style="height:6.0241em;vertical-align:-2.7621em;"></span><span class=mord ><span class=mtable ><span class=col-align-r ><span class="vlist-t vlist-t2"><span class=vlist-r ><span class=vlist  style="height:3.2621em;"><span style="top:-5.4221em;"><span class=pstrut  style="height:3em;"></span><span class=mord ><span class="mord text"><span class="mord textbf">y</span></span></span></span><span style="top:-3.8979em;"><span class=pstrut  style="height:3em;"></span><span class=mord ><span class="mord text"><span class="mord textbf">K</span></span></span></span><span style="top:-2.3979em;"><span class=pstrut  style="height:3em;"></span><span class=mord ><span class="mord text"><span class="mord textbf">x</span></span></span></span><span style="top:-0.8979em;"><span class=pstrut  style="height:3em;"></span><span class=mord ><span class="mord text"><span class="mord textbf">P</span></span></span></span></span><span class=vlist-s >​</span></span><span class=vlist-r ><span class=vlist  style="height:2.7621em;"><span></span></span></span></span></span><span class=col-align-l ><span class="vlist-t vlist-t2"><span class=vlist-r ><span class=vlist  style="height:3.2621em;"><span style="top:-5.4221em;"><span class=pstrut  style="height:3em;"></span><span class=mord ><span class=mord ></span><span class=mspace  style="margin-right:0.2778em;"></span><span class=mrel >=</span><span class=mspace  style="margin-right:0.2778em;"></span><span class="mord text"><span class="mord textbf">z</span></span><span class=mspace  style="margin-right:0.2222em;"></span><span class=mbin >−</span><span class=mspace  style="margin-right:0.2222em;"></span><span class="mord text"><span class="mord textbf">H</span></span><span class="mord accent"><span class=vlist-t ><span class=vlist-r ><span class=vlist  style="height:0.5812em;"><span style="top:-3em;"><span class=pstrut  style="height:3em;"></span><span class="mord text"><span class="mord textbf">x</span></span></span><span style="top:-3.0134em;"><span class=pstrut  style="height:3em;"></span><span class=accent-body  style="left:-0.25em;"><span class=mord >ˉ</span></span></span></span></span></span></span></span></span><span style="top:-3.8979em;"><span class=pstrut  style="height:3em;"></span><span class=mord ><span class=mord ></span><span class=mspace  style="margin-right:0.2778em;"></span><span class=mrel >=</span><span class=mspace  style="margin-right:0.2778em;"></span><span class="mord accent"><span class=vlist-t ><span class=vlist-r ><span class=vlist  style="height:0.8229em;"><span style="top:-3em;"><span class=pstrut  style="height:3em;"></span><span class="mord text"><span class="mord textbf">P</span></span></span><span style="top:-3.2551em;"><span class=pstrut  style="height:3em;"></span><span class=accent-body  style="left:-0.25em;"><span class=mord >ˉ</span></span></span></span></span></span></span><span class=mord ><span class="mord text"><span class="mord textbf">H</span></span><span class=msupsub ><span class=vlist-t ><span class=vlist-r ><span class=vlist  style="height:0.7404em;"><span style="top:-3.139em;margin-right:0.05em;"><span class=pstrut  style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mbin amsrm mtight">⊺</span></span></span></span></span></span></span></span><span class=mopen >(</span><span class="mord text"><span class="mord textbf">H</span></span><span class="mord accent"><span class=vlist-t ><span class=vlist-r ><span class=vlist  style="height:0.8229em;"><span style="top:-3em;"><span class=pstrut  style="height:3em;"></span><span class="mord text"><span class="mord textbf">P</span></span></span><span style="top:-3.2551em;"><span class=pstrut  style="height:3em;"></span><span class=accent-body  style="left:-0.25em;"><span class=mord >ˉ</span></span></span></span></span></span></span><span class=mord ><span class="mord text"><span class="mord textbf">H</span></span><span class=msupsub ><span class=vlist-t ><span class=vlist-r ><span class=vlist  style="height:0.7404em;"><span style="top:-3.139em;margin-right:0.05em;"><span class=pstrut  style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mbin amsrm mtight">⊺</span></span></span></span></span></span></span></span><span class=mspace  style="margin-right:0.2222em;"></span><span class=mbin >+</span><span class=mspace  style="margin-right:0.2222em;"></span><span class="mord text"><span class="mord textbf">R</span></span><span class=mclose ><span class=mclose >)</span><span class=msupsub ><span class=vlist-t ><span class=vlist-r ><span class=vlist  style="height:0.8641em;"><span style="top:-3.113em;margin-right:0.05em;"><span class=pstrut  style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">−</span><span class="mord mtight">1</span></span></span></span></span></span></span></span></span></span></span><span style="top:-2.3979em;"><span class=pstrut  style="height:3em;"></span><span class=mord ><span class=mord ></span><span class=mspace  style="margin-right:0.2778em;"></span><span class=mrel >=</span><span class=mspace  style="margin-right:0.2778em;"></span><span class="mord accent"><span class=vlist-t ><span class=vlist-r ><span class=vlist  style="height:0.5812em;"><span style="top:-3em;"><span class=pstrut  style="height:3em;"></span><span class="mord text"><span class="mord textbf">x</span></span></span><span style="top:-3.0134em;"><span class=pstrut  style="height:3em;"></span><span class=accent-body  style="left:-0.25em;"><span class=mord >ˉ</span></span></span></span></span></span></span><span class=mspace  style="margin-right:0.2222em;"></span><span class=mbin >+</span><span class=mspace  style="margin-right:0.2222em;"></span><span class="mord text"><span class="mord textbf">K</span></span><span class="mord text"><span class="mord textbf">y</span></span></span></span><span style="top:-0.8979em;"><span class=pstrut  style="height:3em;"></span><span class=mord ><span class=mord ></span><span class=mspace  style="margin-right:0.2778em;"></span><span class=mrel >=</span><span class=mspace  style="margin-right:0.2778em;"></span><span class=mopen >(</span><span class="mord text"><span class="mord textbf">I</span></span><span class=mspace  style="margin-right:0.2222em;"></span><span class=mbin >−</span><span class=mspace  style="margin-right:0.2222em;"></span><span class="mord text"><span class="mord textbf">K</span></span><span class="mord text"><span class="mord textbf">H</span></span><span class=mclose >)</span><span class="mord accent"><span class=vlist-t ><span class=vlist-r ><span class=vlist  style="height:0.8229em;"><span style="top:-3em;"><span class=pstrut  style="height:3em;"></span><span class="mord text"><span class="mord textbf">P</span></span></span><span style="top:-3.2551em;"><span class=pstrut  style="height:3em;"></span><span class=accent-body  style="left:-0.25em;"><span class=mord >ˉ</span></span></span></span></span></span></span></span></span></span><span class=vlist-s >​</span></span><span class=vlist-r ><span class=vlist  style="height:2.7621em;"><span></span></span></span></span></span></span></span></span></span></span></span> <p>Where <span class=katex ><span class=katex-mathml ><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mtext mathvariant=bold >H</mtext></mrow><annotation encoding="application/x-tex">\textbf H</annotation></semantics></math></span><span class=katex-html  aria-hidden=true ><span class=base ><span class=strut  style="height:0.6861em;"></span><span class="mord text"><span class="mord textbf">H</span></span></span></span></span> is the measurement matrix, <span class=katex ><span class=katex-mathml ><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi mathvariant=bold >z</mi></mrow><annotation encoding="application/x-tex">\mathbf z</annotation></semantics></math></span><span class=katex-html  aria-hidden=true ><span class=base ><span class=strut  style="height:0.4444em;"></span><span class="mord mathbf">z</span></span></span></span>, <span class=katex ><span class=katex-mathml ><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mtext mathvariant=bold >R</mtext></mrow><annotation encoding="application/x-tex">\textbf R</annotation></semantics></math></span><span class=katex-html  aria-hidden=true ><span class=base ><span class=strut  style="height:0.6861em;"></span><span class="mord text"><span class="mord textbf">R</span></span></span></span></span> are the measurement mean and noise covariance, and <span class=katex ><span class=katex-mathml ><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mtext mathvariant=bold >y</mtext></mrow><annotation encoding="application/x-tex">\textbf y</annotation></semantics></math></span><span class=katex-html  aria-hidden=true ><span class=base ><span class=strut  style="height:0.6389em;vertical-align:-0.1944em;"></span><span class="mord text"><span class="mord textbf">y</span></span></span></span></span>, <span class=katex ><span class=katex-mathml ><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mtext mathvariant=bold >K</mtext></mrow><annotation encoding="application/x-tex">\textbf K</annotation></semantics></math></span><span class=katex-html  aria-hidden=true ><span class=base ><span class=strut  style="height:0.6861em;"></span><span class="mord text"><span class="mord textbf">K</span></span></span></span></span> are the residual and Kalman gain.</p> <h1 id=kalman_filter_implementation ><a href="#kalman_filter_implementation" class=header-anchor >Kalman Filter Implementation</a></h1> <p>First let&#39;s import some required libraries &#40;optionally I also defined some custom plot styles&#41;:</p> <pre><code class="julia hljs"><span class=hljs-keyword >using</span> Random, LinearAlgebra, Distributions, CairoMakie

<span class=hljs-comment ># custom plot styling</span>
CairoMakie.activate!(type = <span class=hljs-string >&quot;svg&quot;</span>)
set_theme!(theme_minimal())

gray_val = <span class=hljs-number >150</span>
gray_col = Makie.RGB(gray_val/<span class=hljs-number >255</span>, gray_val/<span class=hljs-number >255</span>, gray_val/<span class=hljs-number >255</span>)

update_theme!(
    fonts = (; regular = <span class=hljs-string >&quot;JuliaMono-Light&quot;</span>, bold = <span class=hljs-string >&quot;JuliaMono-Light&quot;</span>),
    Axis = (
        leftspinevisible = <span class=hljs-literal >true</span>,
        rightspinevisible = <span class=hljs-literal >false</span>,
        bottomspinevisible = <span class=hljs-literal >true</span>,
        topspinevisible = <span class=hljs-literal >false</span>,
        leftspinecolor = gray_col,
        bottomspinecolor = gray_col,
        xtickcolor = gray_col,
        xticksvisible = <span class=hljs-literal >true</span>,
        xminorticksvisible = <span class=hljs-literal >true</span>,
        xminortickcolor = gray_col,
        ytickcolor = gray_col,
        yticksvisible = <span class=hljs-literal >true</span>,
        yminorticksvisible = <span class=hljs-literal >true</span>,
        yminortickcolor = gray_col,
        xminortickalign = <span class=hljs-number >1.0</span>,
        xtickalign = <span class=hljs-number >1.0</span>,
        yminortickalign = <span class=hljs-number >1.0</span>,
        ytickalign = <span class=hljs-number >1.0</span>,
        yticksize=<span class=hljs-number >7</span>, xticksize=<span class=hljs-number >7</span>,
        yminorticksize=<span class=hljs-number >5</span>, xminorticksize=<span class=hljs-number >5</span>,
        xticklabelsize=<span class=hljs-number >13.0f0</span>, yticklabelsize=<span class=hljs-number >13.0f0</span>
    )
)</code></pre> <p>Let&#39;s start by creating two <code>struct</code>s to keep track of our system state and Kalman filter:</p> <pre><code class="julia hljs"><span class=hljs-keyword >mutable struct</span> State
    mean::<span class=hljs-built_in >AbstractVector</span>
    cov::<span class=hljs-built_in >AbstractMatrix</span>
<span class=hljs-keyword >end</span>

<span class=hljs-keyword >mutable struct</span> KalmanFilter
    state::State
    state_transition::<span class=hljs-built_in >AbstractMatrix</span>
    process_cov::<span class=hljs-built_in >AbstractMatrix</span>
    measurement_function::<span class=hljs-built_in >AbstractMatrix</span>
    measurement_noise_cov::<span class=hljs-built_in >AbstractArray</span>
<span class=hljs-keyword >end</span></code></pre> <p>Next let&#39;s define a function to implement the prediction step of the Kalman filter:</p> <pre><code class="julia hljs"><span class=hljs-keyword >function</span> kalman_predict!(kf::KalmanFilter)
    kf.state.mean = kf.state_transition * kf.state.mean
    kf.state.cov = kf.state_transition * kf.state.cov * kf.state_transition&#x27; + kf.process_cov
<span class=hljs-keyword >end</span></code></pre> <p>As can be seen, this step does not require any outside input, the filter encodes all of the information necessary to predict the state of the system after a single timestep given the existing state. </p> <p>Also, I am making my code and variable names verbose so as to clearly show what is going on, as the equations involved in the Kalman filter are quite long.</p> <p>Next let&#39;s implement the update step:</p> <pre><code class="julia hljs"><span class=hljs-keyword >function</span> kalman_update!(kf::KalmanFilter, measurement::<span class=hljs-built_in >Vector</span>)
    y = measurement - kf.measurement_function*kf.state.mean

    kalman_gain = kf.state.cov*kf.measurement_function&#x27; * 
        inv(
            kf.measurement_function*kf.state.cov*kf.measurement_function&#x27; + 
            kf.measurement_noise_cov
        )

    kf.state.mean += kalman_gain*y

    I_mat = I(size(kalman_gain, <span class=hljs-number >1</span>))

    kf.state.cov = (I_mat - kalman_gain*kf.measurement_function) * kf.state.cov *
        (I_mat - kalman_gain*kf.measurement_function)&#x27; + 
        kalman_gain*kf.measurement_noise_cov*kalman_gain&#x27;
<span class=hljs-keyword >end</span></code></pre> <p>This function takes in a vector of measurements, and using this measurements to refine the prediction of the filter.</p> <p>Finally I&#39;ll define a thin wrapper to run both steps given a measurement and update the state mean and covariance:</p> <pre><code class="julia hljs"><span class=hljs-keyword >function</span> kalman_step!(kf::KalmanFilter, measurement::<span class=hljs-built_in >AbstractVector</span>)
    kalman_predict!(kf)
    kalman_update!(kf, measurement)
<span class=hljs-keyword >end</span></code></pre> <h1 id=running_a_simple_tracking_simulation ><a href="#running_a_simple_tracking_simulation" class=header-anchor >Running a Simple Tracking Simulation</a></h1> <p>To test our code, let&#39;s do a simple example involving the tracking of an object moving at a constant speed. In the one-dimensional case, our equations of motion for our object are:</p> <span class=katex-display ><span class=katex ><span class=katex-mathml ><math xmlns="http://www.w3.org/1998/Math/MathML" display=block ><semantics><mtable rowspacing=0.25em  columnalign="right left" columnspacing=0em ><mtr><mtd><mstyle scriptlevel=0  displaystyle=true ><msub><mi>x</mi><mrow><mi>k</mi><mo>+</mo><mn>1</mn></mrow></msub></mstyle></mtd><mtd><mstyle scriptlevel=0  displaystyle=true ><mrow><mrow></mrow><mo>=</mo><msub><mi>x</mi><mi>k</mi></msub><mo>+</mo><msub><mover accent=true ><mi>x</mi><mo>˙</mo></mover><mi>k</mi></msub><mi mathvariant=normal >Δ</mi><mi>t</mi></mrow></mstyle></mtd></mtr><mtr><mtd><mstyle scriptlevel=0  displaystyle=true ><msub><mover accent=true ><mi>x</mi><mo>˙</mo></mover><mrow><mi>k</mi><mo>+</mo><mn>1</mn></mrow></msub></mstyle></mtd><mtd><mstyle scriptlevel=0  displaystyle=true ><mrow><mrow></mrow><mo>=</mo><msub><mover accent=true ><mi>x</mi><mo>˙</mo></mover><mi>k</mi></msub></mrow></mstyle></mtd></mtr></mtable><annotation encoding="application/x-tex"> \begin{aligned} x_{k+1} &amp;= x_k + \dot x_k \Delta t \\ \dot x_{k+1} &amp;= \dot x_k \end{aligned} </annotation></semantics></math></span><span class=katex-html  aria-hidden=true ><span class=base ><span class=strut  style="height:3em;vertical-align:-1.25em;"></span><span class=mord ><span class=mtable ><span class=col-align-r ><span class="vlist-t vlist-t2"><span class=vlist-r ><span class=vlist  style="height:1.75em;"><span style="top:-3.91em;"><span class=pstrut  style="height:3em;"></span><span class=mord ><span class=mord ><span class="mord mathnormal">x</span><span class=msupsub ><span class="vlist-t vlist-t2"><span class=vlist-r ><span class=vlist  style="height:0.3361em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class=pstrut  style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:0.03148em;">k</span><span class="mbin mtight">+</span><span class="mord mtight">1</span></span></span></span></span><span class=vlist-s >​</span></span><span class=vlist-r ><span class=vlist  style="height:0.2083em;"><span></span></span></span></span></span></span></span></span><span style="top:-2.41em;"><span class=pstrut  style="height:3em;"></span><span class=mord ><span class=mord ><span class="mord accent"><span class=vlist-t ><span class=vlist-r ><span class=vlist  style="height:0.6679em;"><span style="top:-3em;"><span class=pstrut  style="height:3em;"></span><span class="mord mathnormal">x</span></span><span style="top:-3em;"><span class=pstrut  style="height:3em;"></span><span class=accent-body  style="left:-0.1111em;"><span class=mord >˙</span></span></span></span></span></span></span><span class=msupsub ><span class="vlist-t vlist-t2"><span class=vlist-r ><span class=vlist  style="height:0.3361em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class=pstrut  style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:0.03148em;">k</span><span class="mbin mtight">+</span><span class="mord mtight">1</span></span></span></span></span><span class=vlist-s >​</span></span><span class=vlist-r ><span class=vlist  style="height:0.2083em;"><span></span></span></span></span></span></span></span></span></span><span class=vlist-s >​</span></span><span class=vlist-r ><span class=vlist  style="height:1.25em;"><span></span></span></span></span></span><span class=col-align-l ><span class="vlist-t vlist-t2"><span class=vlist-r ><span class=vlist  style="height:1.75em;"><span style="top:-3.91em;"><span class=pstrut  style="height:3em;"></span><span class=mord ><span class=mord ></span><span class=mspace  style="margin-right:0.2778em;"></span><span class=mrel >=</span><span class=mspace  style="margin-right:0.2778em;"></span><span class=mord ><span class="mord mathnormal">x</span><span class=msupsub ><span class="vlist-t vlist-t2"><span class=vlist-r ><span class=vlist  style="height:0.3361em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class=pstrut  style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.03148em;">k</span></span></span></span><span class=vlist-s >​</span></span><span class=vlist-r ><span class=vlist  style="height:0.15em;"><span></span></span></span></span></span></span><span class=mspace  style="margin-right:0.2222em;"></span><span class=mbin >+</span><span class=mspace  style="margin-right:0.2222em;"></span><span class=mord ><span class="mord accent"><span class=vlist-t ><span class=vlist-r ><span class=vlist  style="height:0.6679em;"><span style="top:-3em;"><span class=pstrut  style="height:3em;"></span><span class="mord mathnormal">x</span></span><span style="top:-3em;"><span class=pstrut  style="height:3em;"></span><span class=accent-body  style="left:-0.1111em;"><span class=mord >˙</span></span></span></span></span></span></span><span class=msupsub ><span class="vlist-t vlist-t2"><span class=vlist-r ><span class=vlist  style="height:0.3361em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class=pstrut  style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.03148em;">k</span></span></span></span><span class=vlist-s >​</span></span><span class=vlist-r ><span class=vlist  style="height:0.15em;"><span></span></span></span></span></span></span><span class=mord >Δ</span><span class="mord mathnormal">t</span></span></span><span style="top:-2.41em;"><span class=pstrut  style="height:3em;"></span><span class=mord ><span class=mord ></span><span class=mspace  style="margin-right:0.2778em;"></span><span class=mrel >=</span><span class=mspace  style="margin-right:0.2778em;"></span><span class=mord ><span class="mord accent"><span class=vlist-t ><span class=vlist-r ><span class=vlist  style="height:0.6679em;"><span style="top:-3em;"><span class=pstrut  style="height:3em;"></span><span class="mord mathnormal">x</span></span><span style="top:-3em;"><span class=pstrut  style="height:3em;"></span><span class=accent-body  style="left:-0.1111em;"><span class=mord >˙</span></span></span></span></span></span></span><span class=msupsub ><span class="vlist-t vlist-t2"><span class=vlist-r ><span class=vlist  style="height:0.3361em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class=pstrut  style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.03148em;">k</span></span></span></span><span class=vlist-s >​</span></span><span class=vlist-r ><span class=vlist  style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span><span class=vlist-s >​</span></span><span class=vlist-r ><span class=vlist  style="height:1.25em;"><span></span></span></span></span></span></span></span></span></span></span></span> <p>From these equations, the state transition matrix can easily be defined:</p> <span class=katex-display ><span class=katex ><span class=katex-mathml ><math xmlns="http://www.w3.org/1998/Math/MathML" display=block ><semantics><mrow><mi mathvariant=bold >F</mi><mo>=</mo><mrow><mo fence=true >[</mo><mtable rowspacing=0.16em  columnalign="center center" columnspacing=1em ><mtr><mtd><mstyle scriptlevel=0  displaystyle=false ><mn>1</mn></mstyle></mtd><mtd><mstyle scriptlevel=0  displaystyle=false ><mrow><mi mathvariant=normal >Δ</mi><mi>t</mi></mrow></mstyle></mtd></mtr><mtr><mtd><mstyle scriptlevel=0  displaystyle=false ><mn>0</mn></mstyle></mtd><mtd><mstyle scriptlevel=0  displaystyle=false ><mn>1</mn></mstyle></mtd></mtr></mtable><mo fence=true >]</mo></mrow></mrow><annotation encoding="application/x-tex"> \mathbf F = \begin{bmatrix} 1 &amp; \Delta t \\ 0 &amp; 1 \end{bmatrix} </annotation></semantics></math></span><span class=katex-html  aria-hidden=true ><span class=base ><span class=strut  style="height:0.6861em;"></span><span class="mord mathbf">F</span><span class=mspace  style="margin-right:0.2778em;"></span><span class=mrel >=</span><span class=mspace  style="margin-right:0.2778em;"></span></span><span class=base ><span class=strut  style="height:2.4em;vertical-align:-0.95em;"></span><span class=minner ><span class="mopen delimcenter" style="top:0em;"><span class="delimsizing size3">[</span></span><span class=mord ><span class=mtable ><span class=col-align-c ><span class="vlist-t vlist-t2"><span class=vlist-r ><span class=vlist  style="height:1.45em;"><span style="top:-3.61em;"><span class=pstrut  style="height:3em;"></span><span class=mord ><span class=mord >1</span></span></span><span style="top:-2.41em;"><span class=pstrut  style="height:3em;"></span><span class=mord ><span class=mord >0</span></span></span></span><span class=vlist-s >​</span></span><span class=vlist-r ><span class=vlist  style="height:0.95em;"><span></span></span></span></span></span><span class=arraycolsep  style="width:0.5em;"></span><span class=arraycolsep  style="width:0.5em;"></span><span class=col-align-c ><span class="vlist-t vlist-t2"><span class=vlist-r ><span class=vlist  style="height:1.45em;"><span style="top:-3.61em;"><span class=pstrut  style="height:3em;"></span><span class=mord ><span class=mord >Δ</span><span class="mord mathnormal">t</span></span></span><span style="top:-2.41em;"><span class=pstrut  style="height:3em;"></span><span class=mord ><span class=mord >1</span></span></span></span><span class=vlist-s >​</span></span><span class=vlist-r ><span class=vlist  style="height:0.95em;"><span></span></span></span></span></span></span></span><span class="mclose delimcenter" style="top:0em;"><span class="delimsizing size3">]</span></span></span></span></span></span></span> <p>First let&#39;s define some helper functions to generate some data, and to run the filter for the entire simulation timespan:</p> <pre><code class="julia hljs"><span class=hljs-keyword >function</span> compute_test_data(z_var, process_var; count=<span class=hljs-number >1</span>, dt=<span class=hljs-number >1.0</span>)
    x, vel = <span class=hljs-number >0.0</span>, <span class=hljs-number >1.0</span>
    
    z_noise = Normal(<span class=hljs-number >0.0</span>, sqrt(z_var))
    p_noise = Normal(<span class=hljs-number >0.0</span>, sqrt(process_var))
    
    xs, zs = <span class=hljs-built_in >Float64</span>[], <span class=hljs-built_in >Float64</span>[]
        
    <span class=hljs-keyword >for</span> _ <span class=hljs-keyword >in</span> <span class=hljs-number >1</span>:count
        v = vel + rand(p_noise)
        x += v * dt
        
        push!(xs, x)
        push!(zs, x + rand(z_noise))
    <span class=hljs-keyword >end</span>
    
    <span class=hljs-keyword >return</span> xs, zs
<span class=hljs-keyword >end</span>

<span class=hljs-keyword >function</span> run_filter(count, filter::KalmanFilter; z_var=<span class=hljs-number >10.0</span>, process_var=<span class=hljs-number >0.01</span>)
    track, zs = compute_test_data(z_var, process_var, count=count, dt=dt)
    
    xs, cov = [], []
    
    <span class=hljs-keyword >for</span> z <span class=hljs-keyword >in</span> zs
        kalman_step!(filter, [z])
        
        push!(xs, filter.state.mean)
        push!(cov, filter.state.cov)
    <span class=hljs-keyword >end</span>
    
    <span class=hljs-keyword >return</span> xs, cov, zs, track
<span class=hljs-keyword >end</span></code></pre> <p>Let&#39;s define the parameters for our filter and run the simulation:</p> <pre><code class="julia hljs">x = [<span class=hljs-number >0.0</span>, <span class=hljs-number >0.0</span>]

P = [
    <span class=hljs-number >500.0</span> <span class=hljs-number >0.0</span>
    <span class=hljs-number >0.0</span> <span class=hljs-number >49.0</span>
]

dt = <span class=hljs-number >1.0</span>

F = [
    <span class=hljs-number >1</span> dt
    <span class=hljs-number >0</span> <span class=hljs-number >1</span>
]

Q = I(<span class=hljs-number >2</span>).*<span class=hljs-number >0.01</span>

H = [<span class=hljs-number >1</span> <span class=hljs-number >0</span>]

R = [<span class=hljs-number >10.0</span>]

test_filter = KalmanFilter(State(x, P), F, Q, H, R)

xs, cov, zs, track = run_filter(<span class=hljs-number >50</span>, test_filter)</code></pre> <p>Let&#39;s see how well our filter performed:</p> <pre><code class="julia hljs">fig1 = Figure()
ax1 = Axis(fig1[<span class=hljs-number >1</span>,<span class=hljs-number >1</span>]; ylabel=<span class=hljs-string >&quot;Position (m)&quot;</span>)

<span class=hljs-comment ># plotting true position</span>
times = <span class=hljs-built_in >LinRange</span>(<span class=hljs-number >0</span>, <span class=hljs-number >50</span>, <span class=hljs-number >50</span>)
lines!(
    ax1, times, track; 
    label=<span class=hljs-string >&quot;Track&quot;</span>, linestyle=:dash, color=<span class=hljs-string >&quot;#002c40&quot;</span>
)

<span class=hljs-comment ># plotting filter results and position variance</span>
position = [x[<span class=hljs-number >1</span>] <span class=hljs-keyword >for</span> x <span class=hljs-keyword >in</span> xs]
position_cov = [sqrt(c[<span class=hljs-number >1</span>,<span class=hljs-number >1</span>]) <span class=hljs-keyword >for</span> c <span class=hljs-keyword >in</span> cov]

lines!(ax1, times, position; label=<span class=hljs-string >&quot;Filter&quot;</span>, color=<span class=hljs-string >&quot;#ffa600&quot;</span>)	
band!(
    ax1, times, 
    position .+ position_cov, position .- position_cov; 
    color=(<span class=hljs-string >&quot;#ffa600&quot;</span>, <span class=hljs-number >0.25</span>)
)

<span class=hljs-comment ># plotting measurements</span>
scatter!(
    ax1, times, zs; 
    label=<span class=hljs-string >&quot;Measurements&quot;</span>, marker=:utriangle, color=<span class=hljs-string >&quot;#007f52&quot;</span>
)

axislegend(ax1; position=:rb)

ax12 = Axis(fig1[<span class=hljs-number >2</span>,<span class=hljs-number >1</span>]; xlabel=<span class=hljs-string >&quot;Time (s)&quot;</span>, ylabel=<span class=hljs-string >&quot;Variance&quot;</span>, yscale=log10)

lines!(ax12, times, position_cov, label=<span class=hljs-string >&quot;Position&quot;</span>)
lines!(ax12, times, [sqrt(c[<span class=hljs-number >2</span>,<span class=hljs-number >2</span>]) <span class=hljs-keyword >for</span> c <span class=hljs-keyword >in</span> cov], label=<span class=hljs-string >&quot;Velocity&quot;</span>)

axislegend(ax12)

fig1</code></pre> <div class=im-100 ><img src="/starcoffee/assets/posts/kalman-filter-julia/code/fig1.svg" alt=""></div> <p>Obviously this filter can be adjusted and tuned for better performance, but we can clearly see that the filter estimates appear closer to the actual track than if we were to take the measurements as the &quot;true&quot; value of the system. Using Gaussian distributions to model our state also provides the benefit of giving a measure of the uncertainty of our state.</p> <p>We can also see the position and velocity variances lowering then plateauing over time. A filter should settle over time, but due to the inherent noise present in the system, it will never reach zero variance.</p> <h1 id=conclusion ><a href="#conclusion" class=header-anchor >Conclusion</a></h1> <p>This was a very brief and minimal implementation of a linear Kalman filter in Julia. There is much more theory and further work that goes into state estimation, so if you&#39;re intersted in learning more, please see the excellent reference below. Regardless, I hope this post was helpful in some way.</p> <p>I am trying to update this blog on a regular basis again, however &#40;fortunately for me&#41; I have found a fulltime job and will have much less time to write regularly from here on out. I really enjoy writing these posts and learning interesting things, so I will try my best to keep putting stuff out, potentially mixing more casual posts in the style of <a href="https://michaszj.github.io/starcoffee/posts/on-dws-in-tft/">my previous one</a>. </p> <p>Until next time.</p> <h1 id=references ><a href="#references" class=header-anchor >References</a></h1> <ul> <li><p><a href="https://github.com/rlabbe/Kalman-and-Bayesian-Filters-in-Python">Kalman and Bayesian Filters in Python</a></p> </ul> <div class=page-foot > <a href="http://creativecommons.org/licenses/by-sa/4.0/">CC BY-SA 4.0</a> <a href="https://michaszj.github.io/">Michal Jagodzinski</a>. Last modified: September 10, 2023. <br>Website built with <a href="https://github.com/tlienart/Franklin.jl">Franklin.jl</a> and the <a href="https://julialang.org">Julia programming language</a>. </div> </div> </div> </div> <script src="/starcoffee/libs/highlight/highlight.min.js"></script> <script>hljs.highlightAll();hljs.configure({tabReplace: ' '});</script> <label for=sidebar-checkbox  class=sidebar-toggle ></label>