<!doctype html> <html lang=en > <meta charset=UTF-8 > <meta name=viewport  content="width=device-width, initial-scale=1"> <link rel=preconnect  href="https://fonts.googleapis.com"> <link rel=preconnect  href="https://fonts.gstatic.com" crossorigin> <link href="https://fonts.googleapis.com/css2?family=Cormorant+Garamond:ital,wght@0,400;0,700;1,400;1,700&display=swap" rel=stylesheet > <link rel=stylesheet  href="/starcoffee/libs/katex/katex.min.css"> <link rel=stylesheet  href="/starcoffee/libs/highlight/styles/github.min.css"> <link rel=stylesheet  href="/starcoffee/css/franklin.css"> <link rel=stylesheet  href="/starcoffee/css/poole_lanyon.css"> <link rel=stylesheet  href="/starcoffee/css/adjust.css"> <link rel=icon  href="/starcoffee/assets/favicon.png"> <title>Non-Linear Spacecraft Attitude Dynamics and Control Modelling</title> <input type=checkbox  class=sidebar-checkbox  id=sidebar-checkbox > <div class=sidebar  id=sidebar > <div class=sidebar-item > <p>Star Coffee</p> </div> <nav class=sidebar-nav > <a class="sidebar-nav-item " href="/starcoffee/">Home</a> <a class="sidebar-nav-item " href="/starcoffee/posts/welcome-to-star-coffee/">Welcome to Star Coffee</a> <a class="sidebar-nav-item " href="/starcoffee/posts/projects/">Projects</a> <a class="sidebar-nav-item " href="/starcoffee/posts/satellite-analysis-toolkit/">Satellite Analysis Toolkit</a> <a class="sidebar-nav-item " href="/starcoffee/posts/simple-nn/">Simple NN</a> </nav> <div class=sidebar-item > <p>&copy; Michal Jagodzinski.</p> </div> </div> <!-- Wrap is the content to shift when toggling the sidebar. We wrap the content to avoid any CSS collisions with our real content. --> <div class=wrap > <div class=masthead > <div class=container > <h3 class=masthead-title > <a href="/starcoffee/" title=Home >Star Coffee</a> <small>Writing about stuff, working in public</small> </h3> </div> </div> <div class="container content"> <div class=franklin-content ><h1 id=non-linear_spacecraft_attitude_dynamics_and_control_modelling ><a href="#non-linear_spacecraft_attitude_dynamics_and_control_modelling" class=header-anchor >Non-Linear Spacecraft Attitude Dynamics and Control Modelling</a></h1> <p><em>By Michal Jagodzinski - May 13th, 2023</em></p> <div class=franklin-toc ><ol><li><a href="#brief_aside_spacecraft_attitude_dynamics">Brief Aside: Spacecraft Attitude Dynamics</a><li><a href="#defining_the_non-linear_model">Defining the Non-Linear Model</a><li><a href="#comparison_with_linear_model">Comparison with Linear Model</a><li><a href="#implementing_actuator_dynamics">Implementing Actuator Dynamics</a><li><a href="#wrapping_up">Wrapping Up</a><li><a href="#references">References</a></ol></div> <div class=im-100 ><img src="https://source.unsplash.com/Nz8TnLwQw68" alt="" /></div> <div class=img-caption >Photo by <a href="https://unsplash.com/photos/Nz8TnLwQw68">Hunter Reilly</a></div> <p>We return for some more acausal, component-based modelling with Julia and <code>ModelingToolkit.jl</code>. <a href="https://michaszj.github.io/starcoffee/posts/acausal-sadc-modelling/">In my previous post</a>, I defined and simulated a linear model for the attitude dynamics of spacecraft. In this post, I implement the more realistic, non-linear version and compare its performance with the linearized form.</p> <h2 id=brief_aside_spacecraft_attitude_dynamics ><a href="#brief_aside_spacecraft_attitude_dynamics" class=header-anchor >Brief Aside: Spacecraft Attitude Dynamics</a></h2> <p>The attitude dynamics of a spacecraft are governed by <a href="https://en.wikipedia.org/wiki/Euler&#37;27s_equations_&#40;rigid_body_dynamics&#41;">Euler&#39;s rotation equations</a>, defined as:</p> <span class=katex-display ><span class=katex ><span class=katex-mathml ><math xmlns="http://www.w3.org/1998/Math/MathML" display=block ><semantics><mrow><mi mathvariant=bold >J</mi><mover accent=true ><mi mathvariant=bold >ω</mi><mo>˙</mo></mover><mo>+</mo><msup><mi mathvariant=bold >ω</mi><mo>×</mo></msup><mi mathvariant=bold >J</mi><mi mathvariant=bold >ω</mi><mo>=</mo><mi mathvariant=bold >M</mi></mrow><annotation encoding="application/x-tex"> \mathbf J \dot{\mathbf \omega} + \mathbf \omega^\times \mathbf J \mathbf \omega = \mathbf M </annotation></semantics></math></span><span class=katex-html  aria-hidden=true ><span class=base ><span class=strut  style="height:0.7694em;vertical-align:-0.0833em;"></span><span class="mord mathbf">J</span><span class="mord accent"><span class=vlist-t ><span class=vlist-r ><span class=vlist  style="height:0.6679em;"><span style="top:-3em;"><span class=pstrut  style="height:3em;"></span><span class="mord mathnormal" style="margin-right:0.03588em;">ω</span></span><span style="top:-3em;"><span class=pstrut  style="height:3em;"></span><span class=accent-body  style="left:-0.1389em;"><span class=mord >˙</span></span></span></span></span></span></span><span class=mspace  style="margin-right:0.2222em;"></span><span class=mbin >+</span><span class=mspace  style="margin-right:0.2222em;"></span></span><span class=base ><span class=strut  style="height:0.8213em;"></span><span class=mord ><span class="mord mathnormal" style="margin-right:0.03588em;">ω</span><span class=msupsub ><span class=vlist-t ><span class=vlist-r ><span class=vlist  style="height:0.8213em;"><span style="top:-3.113em;margin-right:0.05em;"><span class=pstrut  style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mbin mtight">×</span></span></span></span></span></span></span></span><span class="mord mathbf">J</span><span class="mord mathnormal" style="margin-right:0.03588em;">ω</span><span class=mspace  style="margin-right:0.2778em;"></span><span class=mrel >=</span><span class=mspace  style="margin-right:0.2778em;"></span></span><span class=base ><span class=strut  style="height:0.6861em;"></span><span class="mord mathbf">M</span></span></span></span></span> <p>The expanded form of these equations, assuming the principal axes form &#40;i.e., the inertia matrix is diagonal&#41;, are defined as:</p> <span class=katex-display ><span class=katex ><span class=katex-mathml ><math xmlns="http://www.w3.org/1998/Math/MathML" display=block ><semantics><mtable rowspacing=0.25em  columnalign="right left" columnspacing=0em ><mtr><mtd><mstyle scriptlevel=0  displaystyle=true ><mrow><msub><mi>J</mi><mi>x</mi></msub><msub><mover accent=true ><mi>ω</mi><mo>˙</mo></mover><mi>x</mi></msub><mo>+</mo><mo stretchy=false >(</mo><msub><mi>J</mi><mi>z</mi></msub><mo>−</mo><msub><mi>J</mi><mi>y</mi></msub><mo stretchy=false >)</mo><msub><mi>ω</mi><mi>y</mi></msub><msub><mi>ω</mi><mi>z</mi></msub></mrow></mstyle></mtd><mtd><mstyle scriptlevel=0  displaystyle=true ><mrow><mrow></mrow><mo>=</mo><msub><mi>M</mi><mi>x</mi></msub></mrow></mstyle></mtd></mtr><mtr><mtd><mstyle scriptlevel=0  displaystyle=true ><mrow><msub><mi>J</mi><mi>x</mi></msub><msub><mover accent=true ><mi>ω</mi><mo>˙</mo></mover><mi>y</mi></msub><mo>+</mo><mo stretchy=false >(</mo><msub><mi>J</mi><mi>x</mi></msub><mo>−</mo><msub><mi>J</mi><mi>z</mi></msub><mo stretchy=false >)</mo><msub><mi>ω</mi><mi>x</mi></msub><msub><mi>ω</mi><mi>z</mi></msub></mrow></mstyle></mtd><mtd><mstyle scriptlevel=0  displaystyle=true ><mrow><mrow></mrow><mo>=</mo><msub><mi>M</mi><mi>y</mi></msub></mrow></mstyle></mtd></mtr><mtr><mtd><mstyle scriptlevel=0  displaystyle=true ><mrow><msub><mi>J</mi><mi>z</mi></msub><msub><mover accent=true ><mi>ω</mi><mo>˙</mo></mover><mi>z</mi></msub><mo>+</mo><mo stretchy=false >(</mo><msub><mi>J</mi><mi>y</mi></msub><mo>−</mo><msub><mi>J</mi><mi>x</mi></msub><mo stretchy=false >)</mo><msub><mi>ω</mi><mi>x</mi></msub><msub><mi>ω</mi><mi>y</mi></msub></mrow></mstyle></mtd><mtd><mstyle scriptlevel=0  displaystyle=true ><mrow><mrow></mrow><mo>=</mo><msub><mi>M</mi><mi>z</mi></msub></mrow></mstyle></mtd></mtr></mtable><annotation encoding="application/x-tex"> \begin{align*} J_x \dot \omega_x + (J_z - J_y) \omega_y \omega_z &amp;= M_x \\ J_x \dot \omega_y + (J_x - J_z) \omega_x \omega_z &amp;= M_y \\ J_z \dot \omega_z + (J_y - J_x) \omega_x \omega_y &amp;= M_z \end{align*} </annotation></semantics></math></span><span class=katex-html  aria-hidden=true ><span class=base ><span class=strut  style="height:4.5em;vertical-align:-2em;"></span><span class=mord ><span class=mtable ><span class=col-align-r ><span class="vlist-t vlist-t2"><span class=vlist-r ><span class=vlist  style="height:2.5em;"><span style="top:-4.66em;"><span class=pstrut  style="height:3em;"></span><span class=mord ><span class=mord ><span class="mord mathnormal" style="margin-right:0.09618em;">J</span><span class=msupsub ><span class="vlist-t vlist-t2"><span class=vlist-r ><span class=vlist  style="height:0.1514em;"><span style="top:-2.55em;margin-left:-0.0962em;margin-right:0.05em;"><span class=pstrut  style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">x</span></span></span></span><span class=vlist-s >​</span></span><span class=vlist-r ><span class=vlist  style="height:0.15em;"><span></span></span></span></span></span></span><span class=mord ><span class="mord accent"><span class=vlist-t ><span class=vlist-r ><span class=vlist  style="height:0.6679em;"><span style="top:-3em;"><span class=pstrut  style="height:3em;"></span><span class="mord mathnormal" style="margin-right:0.03588em;">ω</span></span><span style="top:-3em;"><span class=pstrut  style="height:3em;"></span><span class=accent-body  style="left:-0.1389em;"><span class=mord >˙</span></span></span></span></span></span></span><span class=msupsub ><span class="vlist-t vlist-t2"><span class=vlist-r ><span class=vlist  style="height:0.1514em;"><span style="top:-2.55em;margin-left:-0.0359em;margin-right:0.05em;"><span class=pstrut  style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">x</span></span></span></span><span class=vlist-s >​</span></span><span class=vlist-r ><span class=vlist  style="height:0.15em;"><span></span></span></span></span></span></span><span class=mspace  style="margin-right:0.2222em;"></span><span class=mbin >+</span><span class=mspace  style="margin-right:0.2222em;"></span><span class=mopen >(</span><span class=mord ><span class="mord mathnormal" style="margin-right:0.09618em;">J</span><span class=msupsub ><span class="vlist-t vlist-t2"><span class=vlist-r ><span class=vlist  style="height:0.1514em;"><span style="top:-2.55em;margin-left:-0.0962em;margin-right:0.05em;"><span class=pstrut  style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.04398em;">z</span></span></span></span><span class=vlist-s >​</span></span><span class=vlist-r ><span class=vlist  style="height:0.15em;"><span></span></span></span></span></span></span><span class=mspace  style="margin-right:0.2222em;"></span><span class=mbin >−</span><span class=mspace  style="margin-right:0.2222em;"></span><span class=mord ><span class="mord mathnormal" style="margin-right:0.09618em;">J</span><span class=msupsub ><span class="vlist-t vlist-t2"><span class=vlist-r ><span class=vlist  style="height:0.1514em;"><span style="top:-2.55em;margin-left:-0.0962em;margin-right:0.05em;"><span class=pstrut  style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.03588em;">y</span></span></span></span><span class=vlist-s >​</span></span><span class=vlist-r ><span class=vlist  style="height:0.2861em;"><span></span></span></span></span></span></span><span class=mclose >)</span><span class=mord ><span class="mord mathnormal" style="margin-right:0.03588em;">ω</span><span class=msupsub ><span class="vlist-t vlist-t2"><span class=vlist-r ><span class=vlist  style="height:0.1514em;"><span style="top:-2.55em;margin-left:-0.0359em;margin-right:0.05em;"><span class=pstrut  style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.03588em;">y</span></span></span></span><span class=vlist-s >​</span></span><span class=vlist-r ><span class=vlist  style="height:0.2861em;"><span></span></span></span></span></span></span><span class=mord ><span class="mord mathnormal" style="margin-right:0.03588em;">ω</span><span class=msupsub ><span class="vlist-t vlist-t2"><span class=vlist-r ><span class=vlist  style="height:0.1514em;"><span style="top:-2.55em;margin-left:-0.0359em;margin-right:0.05em;"><span class=pstrut  style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.04398em;">z</span></span></span></span><span class=vlist-s >​</span></span><span class=vlist-r ><span class=vlist  style="height:0.15em;"><span></span></span></span></span></span></span></span></span><span style="top:-3.16em;"><span class=pstrut  style="height:3em;"></span><span class=mord ><span class=mord ><span class="mord mathnormal" style="margin-right:0.09618em;">J</span><span class=msupsub ><span class="vlist-t vlist-t2"><span class=vlist-r ><span class=vlist  style="height:0.1514em;"><span style="top:-2.55em;margin-left:-0.0962em;margin-right:0.05em;"><span class=pstrut  style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">x</span></span></span></span><span class=vlist-s >​</span></span><span class=vlist-r ><span class=vlist  style="height:0.15em;"><span></span></span></span></span></span></span><span class=mord ><span class="mord accent"><span class=vlist-t ><span class=vlist-r ><span class=vlist  style="height:0.6679em;"><span style="top:-3em;"><span class=pstrut  style="height:3em;"></span><span class="mord mathnormal" style="margin-right:0.03588em;">ω</span></span><span style="top:-3em;"><span class=pstrut  style="height:3em;"></span><span class=accent-body  style="left:-0.1389em;"><span class=mord >˙</span></span></span></span></span></span></span><span class=msupsub ><span class="vlist-t vlist-t2"><span class=vlist-r ><span class=vlist  style="height:0.1514em;"><span style="top:-2.55em;margin-left:-0.0359em;margin-right:0.05em;"><span class=pstrut  style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.03588em;">y</span></span></span></span><span class=vlist-s >​</span></span><span class=vlist-r ><span class=vlist  style="height:0.2861em;"><span></span></span></span></span></span></span><span class=mspace  style="margin-right:0.2222em;"></span><span class=mbin >+</span><span class=mspace  style="margin-right:0.2222em;"></span><span class=mopen >(</span><span class=mord ><span class="mord mathnormal" style="margin-right:0.09618em;">J</span><span class=msupsub ><span class="vlist-t vlist-t2"><span class=vlist-r ><span class=vlist  style="height:0.1514em;"><span style="top:-2.55em;margin-left:-0.0962em;margin-right:0.05em;"><span class=pstrut  style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">x</span></span></span></span><span class=vlist-s >​</span></span><span class=vlist-r ><span class=vlist  style="height:0.15em;"><span></span></span></span></span></span></span><span class=mspace  style="margin-right:0.2222em;"></span><span class=mbin >−</span><span class=mspace  style="margin-right:0.2222em;"></span><span class=mord ><span class="mord mathnormal" style="margin-right:0.09618em;">J</span><span class=msupsub ><span class="vlist-t vlist-t2"><span class=vlist-r ><span class=vlist  style="height:0.1514em;"><span style="top:-2.55em;margin-left:-0.0962em;margin-right:0.05em;"><span class=pstrut  style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.04398em;">z</span></span></span></span><span class=vlist-s >​</span></span><span class=vlist-r ><span class=vlist  style="height:0.15em;"><span></span></span></span></span></span></span><span class=mclose >)</span><span class=mord ><span class="mord mathnormal" style="margin-right:0.03588em;">ω</span><span class=msupsub ><span class="vlist-t vlist-t2"><span class=vlist-r ><span class=vlist  style="height:0.1514em;"><span style="top:-2.55em;margin-left:-0.0359em;margin-right:0.05em;"><span class=pstrut  style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">x</span></span></span></span><span class=vlist-s >​</span></span><span class=vlist-r ><span class=vlist  style="height:0.15em;"><span></span></span></span></span></span></span><span class=mord ><span class="mord mathnormal" style="margin-right:0.03588em;">ω</span><span class=msupsub ><span class="vlist-t vlist-t2"><span class=vlist-r ><span class=vlist  style="height:0.1514em;"><span style="top:-2.55em;margin-left:-0.0359em;margin-right:0.05em;"><span class=pstrut  style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.04398em;">z</span></span></span></span><span class=vlist-s >​</span></span><span class=vlist-r ><span class=vlist  style="height:0.15em;"><span></span></span></span></span></span></span></span></span><span style="top:-1.66em;"><span class=pstrut  style="height:3em;"></span><span class=mord ><span class=mord ><span class="mord mathnormal" style="margin-right:0.09618em;">J</span><span class=msupsub ><span class="vlist-t vlist-t2"><span class=vlist-r ><span class=vlist  style="height:0.1514em;"><span style="top:-2.55em;margin-left:-0.0962em;margin-right:0.05em;"><span class=pstrut  style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.04398em;">z</span></span></span></span><span class=vlist-s >​</span></span><span class=vlist-r ><span class=vlist  style="height:0.15em;"><span></span></span></span></span></span></span><span class=mord ><span class="mord accent"><span class=vlist-t ><span class=vlist-r ><span class=vlist  style="height:0.6679em;"><span style="top:-3em;"><span class=pstrut  style="height:3em;"></span><span class="mord mathnormal" style="margin-right:0.03588em;">ω</span></span><span style="top:-3em;"><span class=pstrut  style="height:3em;"></span><span class=accent-body  style="left:-0.1389em;"><span class=mord >˙</span></span></span></span></span></span></span><span class=msupsub ><span class="vlist-t vlist-t2"><span class=vlist-r ><span class=vlist  style="height:0.1514em;"><span style="top:-2.55em;margin-left:-0.0359em;margin-right:0.05em;"><span class=pstrut  style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.04398em;">z</span></span></span></span><span class=vlist-s >​</span></span><span class=vlist-r ><span class=vlist  style="height:0.15em;"><span></span></span></span></span></span></span><span class=mspace  style="margin-right:0.2222em;"></span><span class=mbin >+</span><span class=mspace  style="margin-right:0.2222em;"></span><span class=mopen >(</span><span class=mord ><span class="mord mathnormal" style="margin-right:0.09618em;">J</span><span class=msupsub ><span class="vlist-t vlist-t2"><span class=vlist-r ><span class=vlist  style="height:0.1514em;"><span style="top:-2.55em;margin-left:-0.0962em;margin-right:0.05em;"><span class=pstrut  style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.03588em;">y</span></span></span></span><span class=vlist-s >​</span></span><span class=vlist-r ><span class=vlist  style="height:0.2861em;"><span></span></span></span></span></span></span><span class=mspace  style="margin-right:0.2222em;"></span><span class=mbin >−</span><span class=mspace  style="margin-right:0.2222em;"></span><span class=mord ><span class="mord mathnormal" style="margin-right:0.09618em;">J</span><span class=msupsub ><span class="vlist-t vlist-t2"><span class=vlist-r ><span class=vlist  style="height:0.1514em;"><span style="top:-2.55em;margin-left:-0.0962em;margin-right:0.05em;"><span class=pstrut  style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">x</span></span></span></span><span class=vlist-s >​</span></span><span class=vlist-r ><span class=vlist  style="height:0.15em;"><span></span></span></span></span></span></span><span class=mclose >)</span><span class=mord ><span class="mord mathnormal" style="margin-right:0.03588em;">ω</span><span class=msupsub ><span class="vlist-t vlist-t2"><span class=vlist-r ><span class=vlist  style="height:0.1514em;"><span style="top:-2.55em;margin-left:-0.0359em;margin-right:0.05em;"><span class=pstrut  style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">x</span></span></span></span><span class=vlist-s >​</span></span><span class=vlist-r ><span class=vlist  style="height:0.15em;"><span></span></span></span></span></span></span><span class=mord ><span class="mord mathnormal" style="margin-right:0.03588em;">ω</span><span class=msupsub ><span class="vlist-t vlist-t2"><span class=vlist-r ><span class=vlist  style="height:0.1514em;"><span style="top:-2.55em;margin-left:-0.0359em;margin-right:0.05em;"><span class=pstrut  style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.03588em;">y</span></span></span></span><span class=vlist-s >​</span></span><span class=vlist-r ><span class=vlist  style="height:0.2861em;"><span></span></span></span></span></span></span></span></span></span><span class=vlist-s >​</span></span><span class=vlist-r ><span class=vlist  style="height:2em;"><span></span></span></span></span></span><span class=col-align-l ><span class="vlist-t vlist-t2"><span class=vlist-r ><span class=vlist  style="height:2.5em;"><span style="top:-4.66em;"><span class=pstrut  style="height:3em;"></span><span class=mord ><span class=mord ></span><span class=mspace  style="margin-right:0.2778em;"></span><span class=mrel >=</span><span class=mspace  style="margin-right:0.2778em;"></span><span class=mord ><span class="mord mathnormal" style="margin-right:0.10903em;">M</span><span class=msupsub ><span class="vlist-t vlist-t2"><span class=vlist-r ><span class=vlist  style="height:0.1514em;"><span style="top:-2.55em;margin-left:-0.109em;margin-right:0.05em;"><span class=pstrut  style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">x</span></span></span></span><span class=vlist-s >​</span></span><span class=vlist-r ><span class=vlist  style="height:0.15em;"><span></span></span></span></span></span></span></span></span><span style="top:-3.16em;"><span class=pstrut  style="height:3em;"></span><span class=mord ><span class=mord ></span><span class=mspace  style="margin-right:0.2778em;"></span><span class=mrel >=</span><span class=mspace  style="margin-right:0.2778em;"></span><span class=mord ><span class="mord mathnormal" style="margin-right:0.10903em;">M</span><span class=msupsub ><span class="vlist-t vlist-t2"><span class=vlist-r ><span class=vlist  style="height:0.1514em;"><span style="top:-2.55em;margin-left:-0.109em;margin-right:0.05em;"><span class=pstrut  style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.03588em;">y</span></span></span></span><span class=vlist-s >​</span></span><span class=vlist-r ><span class=vlist  style="height:0.2861em;"><span></span></span></span></span></span></span></span></span><span style="top:-1.66em;"><span class=pstrut  style="height:3em;"></span><span class=mord ><span class=mord ></span><span class=mspace  style="margin-right:0.2778em;"></span><span class=mrel >=</span><span class=mspace  style="margin-right:0.2778em;"></span><span class=mord ><span class="mord mathnormal" style="margin-right:0.10903em;">M</span><span class=msupsub ><span class="vlist-t vlist-t2"><span class=vlist-r ><span class=vlist  style="height:0.1514em;"><span style="top:-2.55em;margin-left:-0.109em;margin-right:0.05em;"><span class=pstrut  style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.04398em;">z</span></span></span></span><span class=vlist-s >​</span></span><span class=vlist-r ><span class=vlist  style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span><span class=vlist-s >​</span></span><span class=vlist-r ><span class=vlist  style="height:2em;"><span></span></span></span></span></span></span></span></span></span></span></span> <p>As can be clearly seen, these equations are non-linear. Thus, to allow for linear analysis, the equations can be linearized by removing the non-linear terms:</p> <span class=katex-display ><span class=katex ><span class=katex-mathml ><math xmlns="http://www.w3.org/1998/Math/MathML" display=block ><semantics><mtable rowspacing=0.25em  columnalign="right left" columnspacing=0em ><mtr><mtd><mstyle scriptlevel=0  displaystyle=true ><mrow><msub><mi>J</mi><mi>x</mi></msub><msub><mover accent=true ><mi>ω</mi><mo>˙</mo></mover><mi>x</mi></msub></mrow></mstyle></mtd><mtd><mstyle scriptlevel=0  displaystyle=true ><mrow><mrow></mrow><mo>=</mo><msub><mi>M</mi><mi>x</mi></msub></mrow></mstyle></mtd></mtr><mtr><mtd><mstyle scriptlevel=0  displaystyle=true ><mrow><msub><mi>J</mi><mi>x</mi></msub><msub><mover accent=true ><mi>ω</mi><mo>˙</mo></mover><mi>y</mi></msub></mrow></mstyle></mtd><mtd><mstyle scriptlevel=0  displaystyle=true ><mrow><mrow></mrow><mo>=</mo><msub><mi>M</mi><mi>y</mi></msub></mrow></mstyle></mtd></mtr><mtr><mtd><mstyle scriptlevel=0  displaystyle=true ><mrow><msub><mi>J</mi><mi>z</mi></msub><msub><mover accent=true ><mi>ω</mi><mo>˙</mo></mover><mi>z</mi></msub></mrow></mstyle></mtd><mtd><mstyle scriptlevel=0  displaystyle=true ><mrow><mrow></mrow><mo>=</mo><msub><mi>M</mi><mi>z</mi></msub></mrow></mstyle></mtd></mtr></mtable><annotation encoding="application/x-tex"> \begin{align*} J_x \dot \omega_x &amp;= M_x \\ J_x \dot \omega_y &amp;= M_y \\ J_z \dot \omega_z &amp;= M_z \end{align*} </annotation></semantics></math></span><span class=katex-html  aria-hidden=true ><span class=base ><span class=strut  style="height:4.5em;vertical-align:-2em;"></span><span class=mord ><span class=mtable ><span class=col-align-r ><span class="vlist-t vlist-t2"><span class=vlist-r ><span class=vlist  style="height:2.5em;"><span style="top:-4.66em;"><span class=pstrut  style="height:3em;"></span><span class=mord ><span class=mord ><span class="mord mathnormal" style="margin-right:0.09618em;">J</span><span class=msupsub ><span class="vlist-t vlist-t2"><span class=vlist-r ><span class=vlist  style="height:0.1514em;"><span style="top:-2.55em;margin-left:-0.0962em;margin-right:0.05em;"><span class=pstrut  style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">x</span></span></span></span><span class=vlist-s >​</span></span><span class=vlist-r ><span class=vlist  style="height:0.15em;"><span></span></span></span></span></span></span><span class=mord ><span class="mord accent"><span class=vlist-t ><span class=vlist-r ><span class=vlist  style="height:0.6679em;"><span style="top:-3em;"><span class=pstrut  style="height:3em;"></span><span class="mord mathnormal" style="margin-right:0.03588em;">ω</span></span><span style="top:-3em;"><span class=pstrut  style="height:3em;"></span><span class=accent-body  style="left:-0.1389em;"><span class=mord >˙</span></span></span></span></span></span></span><span class=msupsub ><span class="vlist-t vlist-t2"><span class=vlist-r ><span class=vlist  style="height:0.1514em;"><span style="top:-2.55em;margin-left:-0.0359em;margin-right:0.05em;"><span class=pstrut  style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">x</span></span></span></span><span class=vlist-s >​</span></span><span class=vlist-r ><span class=vlist  style="height:0.15em;"><span></span></span></span></span></span></span></span></span><span style="top:-3.16em;"><span class=pstrut  style="height:3em;"></span><span class=mord ><span class=mord ><span class="mord mathnormal" style="margin-right:0.09618em;">J</span><span class=msupsub ><span class="vlist-t vlist-t2"><span class=vlist-r ><span class=vlist  style="height:0.1514em;"><span style="top:-2.55em;margin-left:-0.0962em;margin-right:0.05em;"><span class=pstrut  style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">x</span></span></span></span><span class=vlist-s >​</span></span><span class=vlist-r ><span class=vlist  style="height:0.15em;"><span></span></span></span></span></span></span><span class=mord ><span class="mord accent"><span class=vlist-t ><span class=vlist-r ><span class=vlist  style="height:0.6679em;"><span style="top:-3em;"><span class=pstrut  style="height:3em;"></span><span class="mord mathnormal" style="margin-right:0.03588em;">ω</span></span><span style="top:-3em;"><span class=pstrut  style="height:3em;"></span><span class=accent-body  style="left:-0.1389em;"><span class=mord >˙</span></span></span></span></span></span></span><span class=msupsub ><span class="vlist-t vlist-t2"><span class=vlist-r ><span class=vlist  style="height:0.1514em;"><span style="top:-2.55em;margin-left:-0.0359em;margin-right:0.05em;"><span class=pstrut  style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.03588em;">y</span></span></span></span><span class=vlist-s >​</span></span><span class=vlist-r ><span class=vlist  style="height:0.2861em;"><span></span></span></span></span></span></span></span></span><span style="top:-1.66em;"><span class=pstrut  style="height:3em;"></span><span class=mord ><span class=mord ><span class="mord mathnormal" style="margin-right:0.09618em;">J</span><span class=msupsub ><span class="vlist-t vlist-t2"><span class=vlist-r ><span class=vlist  style="height:0.1514em;"><span style="top:-2.55em;margin-left:-0.0962em;margin-right:0.05em;"><span class=pstrut  style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.04398em;">z</span></span></span></span><span class=vlist-s >​</span></span><span class=vlist-r ><span class=vlist  style="height:0.15em;"><span></span></span></span></span></span></span><span class=mord ><span class="mord accent"><span class=vlist-t ><span class=vlist-r ><span class=vlist  style="height:0.6679em;"><span style="top:-3em;"><span class=pstrut  style="height:3em;"></span><span class="mord mathnormal" style="margin-right:0.03588em;">ω</span></span><span style="top:-3em;"><span class=pstrut  style="height:3em;"></span><span class=accent-body  style="left:-0.1389em;"><span class=mord >˙</span></span></span></span></span></span></span><span class=msupsub ><span class="vlist-t vlist-t2"><span class=vlist-r ><span class=vlist  style="height:0.1514em;"><span style="top:-2.55em;margin-left:-0.0359em;margin-right:0.05em;"><span class=pstrut  style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.04398em;">z</span></span></span></span><span class=vlist-s >​</span></span><span class=vlist-r ><span class=vlist  style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span><span class=vlist-s >​</span></span><span class=vlist-r ><span class=vlist  style="height:2em;"><span></span></span></span></span></span><span class=col-align-l ><span class="vlist-t vlist-t2"><span class=vlist-r ><span class=vlist  style="height:2.5em;"><span style="top:-4.66em;"><span class=pstrut  style="height:3em;"></span><span class=mord ><span class=mord ></span><span class=mspace  style="margin-right:0.2778em;"></span><span class=mrel >=</span><span class=mspace  style="margin-right:0.2778em;"></span><span class=mord ><span class="mord mathnormal" style="margin-right:0.10903em;">M</span><span class=msupsub ><span class="vlist-t vlist-t2"><span class=vlist-r ><span class=vlist  style="height:0.1514em;"><span style="top:-2.55em;margin-left:-0.109em;margin-right:0.05em;"><span class=pstrut  style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">x</span></span></span></span><span class=vlist-s >​</span></span><span class=vlist-r ><span class=vlist  style="height:0.15em;"><span></span></span></span></span></span></span></span></span><span style="top:-3.16em;"><span class=pstrut  style="height:3em;"></span><span class=mord ><span class=mord ></span><span class=mspace  style="margin-right:0.2778em;"></span><span class=mrel >=</span><span class=mspace  style="margin-right:0.2778em;"></span><span class=mord ><span class="mord mathnormal" style="margin-right:0.10903em;">M</span><span class=msupsub ><span class="vlist-t vlist-t2"><span class=vlist-r ><span class=vlist  style="height:0.1514em;"><span style="top:-2.55em;margin-left:-0.109em;margin-right:0.05em;"><span class=pstrut  style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.03588em;">y</span></span></span></span><span class=vlist-s >​</span></span><span class=vlist-r ><span class=vlist  style="height:0.2861em;"><span></span></span></span></span></span></span></span></span><span style="top:-1.66em;"><span class=pstrut  style="height:3em;"></span><span class=mord ><span class=mord ></span><span class=mspace  style="margin-right:0.2778em;"></span><span class=mrel >=</span><span class=mspace  style="margin-right:0.2778em;"></span><span class=mord ><span class="mord mathnormal" style="margin-right:0.10903em;">M</span><span class=msupsub ><span class="vlist-t vlist-t2"><span class=vlist-r ><span class=vlist  style="height:0.1514em;"><span style="top:-2.55em;margin-left:-0.109em;margin-right:0.05em;"><span class=pstrut  style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.04398em;">z</span></span></span></span><span class=vlist-s >​</span></span><span class=vlist-r ><span class=vlist  style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span><span class=vlist-s >​</span></span><span class=vlist-r ><span class=vlist  style="height:2em;"><span></span></span></span></span></span></span></span></span></span></span></span> <p>These are the equations of motion that govern the linear model I defined in the previous post. For small angles and angular velocities, the linear equations are decent approximations for the non-linear ones. Regardless, this linearized form does not model the attitude dynamics of a spacecraft completely accurately. By no means is it useless, linear models are still incredibly useful for design and analysis. Linear systems can be analyzed using linear control theory, which gives engineers great insight into the behaviour of systems.</p> <p>However, it is still useful to have a non-linear model for further analysis, and that is what we&#39;ll be covering in this post.</p> <h2 id=defining_the_non-linear_model ><a href="#defining_the_non-linear_model" class=header-anchor >Defining the Non-Linear Model</a></h2> <p>Imports and defining useful constants:</p> <pre><code class="julia hljs"><span class=hljs-keyword >using</span> CairoMakie, AlgebraOfGraphics
<span class=hljs-keyword >using</span> ModelingToolkit, ModelingToolkitStandardLibrary
<span class=hljs-keyword >using</span> DifferentialEquations
set_aog_theme!()

<span class=hljs-meta >@parameters</span> t
<span class=hljs-keyword >const</span> Rot = ModelingToolkitStandardLibrary.Mechanical.Rotational
<span class=hljs-keyword >const</span> B = ModelingToolkitStandardLibrary.Blocks</code></pre> <p>Defining the custom component:</p> <pre><code class="julia hljs"><span class=hljs-meta >@component</span> <span class=hljs-keyword >function</span> SpacecraftAttitude(
    ; name, Jx=<span class=hljs-number >100.0</span>, Jy=<span class=hljs-number >100.0</span>, Jz=<span class=hljs-number >100.0</span>, u0=zeros(<span class=hljs-number >3</span>), ω<span class=hljs-number >0</span>=zeros(<span class=hljs-number >3</span>), ω̇<span class=hljs-number >0</span>=zeros(<span class=hljs-number >3</span>)
)

    <span class=hljs-meta >@named</span> Mx = B.RealInput()
    <span class=hljs-meta >@named</span> My = B.RealInput()
    <span class=hljs-meta >@named</span> Mz = B.RealInput()

    <span class=hljs-meta >@named</span> phi_x = B.RealOutput()
    <span class=hljs-meta >@named</span> phi_y = B.RealOutput()
    <span class=hljs-meta >@named</span> phi_z = B.RealOutput()

    sts = <span class=hljs-meta >@variables</span> ϕ(t)=u0[<span class=hljs-number >1</span>] θ(t)=u0[<span class=hljs-number >2</span>] ψ(t)=u0[<span class=hljs-number >3</span>] ωx(t)=ω<span class=hljs-number >0</span>[<span class=hljs-number >1</span>] ωy(t)=ω<span class=hljs-number >0</span>[<span class=hljs-number >2</span>] ωz(t)=ω<span class=hljs-number >0</span>[<span class=hljs-number >3</span>] ω̇x(t)=ω̇<span class=hljs-number >0</span>[<span class=hljs-number >1</span>] ω̇y(t)=ω̇<span class=hljs-number >0</span>[<span class=hljs-number >2</span>] ω̇z(t)=ω̇<span class=hljs-number >0</span>[<span class=hljs-number >3</span>]

    ps = <span class=hljs-meta >@parameters</span> Jx=Jx Jy=Jy Jz=Jz u0=u0 ω<span class=hljs-number >0</span>=ω<span class=hljs-number >0</span> ω̇<span class=hljs-number >0</span>=ω̇<span class=hljs-number >0</span>

    D = Differential(t)

    eqs = [
        phi_x.u ~ ϕ,
        phi_y.u ~ θ,
        phi_z.u ~ ψ,

        D(ϕ) ~ ωx + ωz * tan(θ)*cos(ϕ) + ωy*tan(θ)*sin(ϕ),
        D(θ) ~ ωy*cos(ϕ) - ωz*sin(ϕ),
        D(ψ) ~ ωz*sec(θ)*cos(ϕ) + ωy*sec(θ)*sin(ϕ),

        D(ωx) ~ ω̇x,
        D(ωy) ~ ω̇y,
        D(ωz) ~ ω̇z,

        Jx * ω̇x ~ Mx.u + (Jy - Jz)*ωy*ωz,
        Jy * ω̇y ~ My.u + (Jz - Jx)*ωx*ωz,
        Jz * ω̇z ~ Mz.u + (Jx - Jy)*ωx*ωy,
    ]

    compose(
        ODESystem(eqs, t, sts, ps; name = name), Mx, My, Mz, phi_x, phi_y, phi_z
    )
<span class=hljs-keyword >end</span></code></pre> <p>This component is defined using an <a href="https://en.wikipedia.org/wiki/Euler_angles">Euler angle</a> attitude representation. Specifically, this uses the 3-2-1 rotation sequence. The <code>Mx</code>, <code>My</code>, and <code>Mz</code> variables are used as the torque inputs to the system, and the resulting Euler angles of the spacecraft can be accessed using the <code>phi_x</code>, <code>phi_y</code>, and <code>phi_z</code> variables.</p> <p>Next, let&#39;s recreate the <a href="https://michaszj.github.io/starcoffee/posts/acausal-sadc-modelling/#pid_control_example">control example from my previous post</a> using this non-linear model:</p> <pre><code class="julia hljs"><span class=hljs-meta >@named</span> sc = SpacecraftAttitude(u0=[<span class=hljs-number >0.5</span>, <span class=hljs-number >0.25</span>, -<span class=hljs-number >0.5</span>])

<span class=hljs-meta >@named</span> setpoint_sca = B.Constant(k=<span class=hljs-number >0</span>)

<span class=hljs-meta >@named</span> feedback_ϕ = B.Feedback()
<span class=hljs-meta >@named</span> feedback_θ = B.Feedback()
<span class=hljs-meta >@named</span> feedback_ψ = B.Feedback()

<span class=hljs-meta >@named</span> ctrl_ϕ = B.PID(k=<span class=hljs-number >10.0</span>, Td=<span class=hljs-number >32.0</span>, Ti=<span class=hljs-number >100</span>)
<span class=hljs-meta >@named</span> torque_ϕ = Rot.Torque()

<span class=hljs-meta >@named</span> ctrl_θ = B.PID(k=<span class=hljs-number >10.0</span>, Td=<span class=hljs-number >32.0</span>, Ti=<span class=hljs-number >100</span>)
<span class=hljs-meta >@named</span> torque_θ = Rot.Torque()

<span class=hljs-meta >@named</span> ctrl_ψ = B.PID(k=<span class=hljs-number >10.0</span>, Td=<span class=hljs-number >32.0</span>, Ti=<span class=hljs-number >100</span>)
<span class=hljs-meta >@named</span> torque_ψ = Rot.Torque()

sca_eqs = [
    connect(setpoint_sca.output, feedback_ϕ.input1),
    connect(feedback_ϕ.output, ctrl_ϕ.err_input),
    connect(ctrl_ϕ.ctr_output, sc.Mx),
    connect(sc.phi_x, feedback_ϕ.input2),

    connect(setpoint_sca.output, feedback_θ.input1),
    connect(feedback_θ.output, ctrl_θ.err_input),
    connect(ctrl_θ.ctr_output, sc.My),
    connect(sc.phi_y, feedback_θ.input2),

    connect(setpoint_sca.output, feedback_ψ.input1),
    connect(feedback_ψ.output, ctrl_ψ.err_input),
    connect(ctrl_ψ.ctr_output, sc.Mz),
    connect(sc.phi_z, feedback_ψ.input2),
]</code></pre> <p>Just as a reminder, here is the block diagram of one axis of the system we are implementing:</p> <div class=im-100 ><img src="/starcoffee/assets/posts/nonlinear-sadc-modelling/code/sim-diagram.svg" alt=""></div> <p>This block diagram represents the following connections:</p> <pre><code class="julia hljs">connect(setpoint_sca.output, feedback_ϕ.input1),
connect(feedback_ϕ.output, ctrl_ϕ.err_input),
connect(ctrl_ϕ.ctr_output, sc.Mx),
connect(sc.phi_x, feedback_ϕ.input2),</code></pre> <p>Next, we can solve the system and plot the results:</p> <pre><code class="julia hljs"><span class=hljs-meta >@named</span> sca_model = ODESystem(sca_eqs, t; systems = [
    sc, setpoint_sca,
    feedback_ϕ, ctrl_ϕ, torque_ϕ,
    feedback_θ, ctrl_θ, torque_θ,
    feedback_ψ, ctrl_ψ, torque_ψ,
])

sca_sys = structural_simplify(sca_model)

sca_prob = ODEProblem(sca_sys, [], (<span class=hljs-number >0</span>, <span class=hljs-number >2.5</span>), [])
sca_sol = solve(sca_prob, Tsit5())</code></pre> <pre><code class="julia hljs">times = <span class=hljs-number >0</span>:<span class=hljs-number >0.01</span>:<span class=hljs-number >2.5</span>
nonlinear_interp = sca_sol(times)

fig1 = Figure()
ax1 = Axis(fig1[<span class=hljs-number >1</span>,<span class=hljs-number >1</span>], xlabel=<span class=hljs-string >&quot;Time (s)&quot;</span>, ylabel=<span class=hljs-string >&quot;Angle (°)&quot;</span>)

lines!(ax1, times, rad2deg.(nonlinear_interp[sc.ϕ]), label=<span class=hljs-string >&quot;ϕ (Roll)&quot;</span>)
lines!(ax1, times, rad2deg.(nonlinear_interp[sc.θ]), label=<span class=hljs-string >&quot;θ (Pitch)&quot;</span>)
lines!(ax1, times, rad2deg.(nonlinear_interp[sc.ψ]), label=<span class=hljs-string >&quot;ψ (Yaw)&quot;</span>)

hlines!(ax1, [<span class=hljs-number >0.0</span>]; label=<span class=hljs-string >&quot;Setpoint&quot;</span>, linestyle=:dash)

axislegend(ax1)

fig1</code></pre> <div class=im-75 ><img src="/starcoffee/assets/posts/nonlinear-sadc-modelling/code/nonlinear-sim.svg" alt=""></div> <p>The results are pretty similar to the linear model, however some non-linear behaviour can be seen.</p> <h2 id=comparison_with_linear_model ><a href="#comparison_with_linear_model" class=header-anchor >Comparison with Linear Model</a></h2> <p>Let&#39;s bring in the linear model and compare its performance with the non-linear model:</p> <pre><code class="julia hljs"><span class=hljs-meta >@component</span> <span class=hljs-keyword >function</span> LinearSpacecraftAttitude(
    ; name, Jx=<span class=hljs-number >100.0</span>, Jy=<span class=hljs-number >100.0</span>, Jz=<span class=hljs-number >100.0</span>, u0=[<span class=hljs-number >0.0</span>,<span class=hljs-number >0.0</span>,<span class=hljs-number >0.0</span>], ω<span class=hljs-number >0</span>=[<span class=hljs-number >0.0</span>,<span class=hljs-number >0.0</span>,<span class=hljs-number >0.0</span>], ω̇<span class=hljs-number >0</span>=[<span class=hljs-number >0.0</span>,<span class=hljs-number >0.0</span>,<span class=hljs-number >0.0</span>]
)

    <span class=hljs-meta >@named</span> Ix = Rot.Inertia(J=Jx, phi_start=u0[<span class=hljs-number >1</span>], w_start=ω<span class=hljs-number >0</span>[<span class=hljs-number >1</span>], a_start=ω̇<span class=hljs-number >0</span>[<span class=hljs-number >1</span>])
    <span class=hljs-meta >@named</span> Iy = Rot.Inertia(J=Jy, phi_start=u0[<span class=hljs-number >2</span>], w_start=ω<span class=hljs-number >0</span>[<span class=hljs-number >2</span>], a_start=ω̇<span class=hljs-number >0</span>[<span class=hljs-number >2</span>])
    <span class=hljs-meta >@named</span> Iz = Rot.Inertia(J=Jz, phi_start=u0[<span class=hljs-number >3</span>], w_start=ω<span class=hljs-number >0</span>[<span class=hljs-number >3</span>], a_start=ω̇<span class=hljs-number >0</span>[<span class=hljs-number >3</span>])

    <span class=hljs-meta >@named</span> x_flange_a = Rot.Flange()
    <span class=hljs-meta >@named</span> y_flange_a = Rot.Flange()
    <span class=hljs-meta >@named</span> z_flange_a = Rot.Flange()

    <span class=hljs-meta >@named</span> x_flange_b = Rot.Flange()
    <span class=hljs-meta >@named</span> y_flange_b = Rot.Flange()
    <span class=hljs-meta >@named</span> z_flange_b = Rot.Flange()

    <span class=hljs-meta >@named</span> ϕ_sensor = Rot.AngleSensor()
    <span class=hljs-meta >@named</span> θ_sensor = Rot.AngleSensor()
    <span class=hljs-meta >@named</span> ψ_sensor = Rot.AngleSensor()

    ps = <span class=hljs-meta >@parameters</span> Jx=Jx Jy=Jy Jz=Jz u0=u0 ω<span class=hljs-number >0</span>=ω<span class=hljs-number >0</span> ω̇<span class=hljs-number >0</span>=ω̇<span class=hljs-number >0</span>

    D = Differential(t)

    eqs = [
        connect(x_flange_a, Ix.flange_a),
        connect(y_flange_a, Iy.flange_a),
        connect(z_flange_a, Iz.flange_a),

        connect(Ix.flange_b, x_flange_b),
        connect(Iy.flange_b, y_flange_b),
        connect(Iz.flange_b, z_flange_b),

        connect(x_flange_b, ϕ_sensor.flange),
        connect(y_flange_b, θ_sensor.flange),
        connect(z_flange_b, ψ_sensor.flange),
    ]

    compose(
        ODESystem(eqs, t, [], ps; name = name),
        Ix, Iy, Iz,
        x_flange_a, y_flange_a, z_flange_a,
        x_flange_b, y_flange_b, z_flange_b,
        ϕ_sensor, θ_sensor, ψ_sensor
    )
<span class=hljs-keyword >end</span></code></pre> <pre><code class="julia hljs"><span class=hljs-meta >@named</span> scl = LinearSpacecraftAttitude(u0=[<span class=hljs-number >0.5</span>, <span class=hljs-number >0.25</span>, -<span class=hljs-number >0.5</span>])

scl_eqs = [
    connect(setpoint_sca.output, feedback_ϕ.input1),
    connect(setpoint_sca.output, feedback_θ.input1),
    connect(setpoint_sca.output, feedback_ψ.input1),

    connect(feedback_ϕ.output, ctrl_ϕ.err_input),
    connect(ctrl_ϕ.ctr_output, torque_ϕ.tau),
    connect(torque_ϕ.flange, scl.x_flange_a),
    connect(scl.ϕ_sensor.phi, feedback_ϕ.input2),

    connect(feedback_θ.output, ctrl_θ.err_input),
    connect(ctrl_θ.ctr_output, torque_θ.tau),
    connect(torque_θ.flange, scl.y_flange_a),
    connect(scl.θ_sensor.phi, feedback_θ.input2),

    connect(feedback_ψ.output, ctrl_ψ.err_input),
    connect(ctrl_ψ.ctr_output, torque_ψ.tau),
    connect(torque_ψ.flange, scl.z_flange_a),
    connect(scl.ψ_sensor.phi, feedback_ψ.input2),
]

<span class=hljs-meta >@named</span> scl_model = ODESystem(scl_eqs, t; systems = [
    scl, setpoint_sca,
    feedback_ϕ, ctrl_ϕ, torque_ϕ,
    feedback_θ, ctrl_θ, torque_θ,
    feedback_ψ, ctrl_ψ, torque_ψ,
])

scl_sys = structural_simplify(scl_model)

scl_prob = ODEProblem(scl_sys, [], (<span class=hljs-number >0</span>, <span class=hljs-number >2.5</span>), [])
scl_sol = solve(scl_prob, Tsit5())</code></pre> <pre><code class="julia hljs">fig2 = Figure(resolution=(<span class=hljs-number >1000</span>,<span class=hljs-number >500</span>))
ax21 = Axis(fig2[<span class=hljs-number >1</span>,<span class=hljs-number >1</span>], xlabel=<span class=hljs-string >&quot;Time (s)&quot;</span>, ylabel=<span class=hljs-string >&quot;Angle (°)&quot;</span>, title=<span class=hljs-string >&quot;ϕ&quot;</span>)

linear_interp = scl_sol(times)

lines!(ax21, times, rad2deg.(nonlinear_interp[sc.ϕ]))
lines!(ax21, times, rad2deg.(linear_interp[scl.Ix.phi]), linestyle=:dash)

ax22 = Axis(fig2[<span class=hljs-number >1</span>,<span class=hljs-number >2</span>], xlabel=<span class=hljs-string >&quot;Time (s)&quot;</span>, title=<span class=hljs-string >&quot;θ&quot;</span>)

lines!(ax22, times, rad2deg.(nonlinear_interp[sc.θ]))
lines!(ax22, times, rad2deg.(linear_interp[scl.Iy.phi]), linestyle=:dash)


ax23 = Axis(fig2[<span class=hljs-number >1</span>,<span class=hljs-number >3</span>], xlabel=<span class=hljs-string >&quot;Time (s)&quot;</span>, title=<span class=hljs-string >&quot;ψ&quot;</span>)

lines!(ax23, times, rad2deg.(nonlinear_interp[sc.ψ]), label=<span class=hljs-string >&quot;Non-Linear&quot;</span>)
lines!(ax23, times, rad2deg.(linear_interp[scl.Iz.phi]), linestyle=:dash, label=<span class=hljs-string >&quot;Linear&quot;</span>)

fig2[<span class=hljs-number >2</span>, <span class=hljs-number >2</span>] = Legend(
    fig2, ax23, <span class=hljs-string >&quot;Model&quot;</span>, framevisible=<span class=hljs-literal >false</span>, orientation=:horizontal, tellwidth=<span class=hljs-literal >false</span>
)

fig2</code></pre> <div class=im-100 ><img src="/starcoffee/assets/posts/nonlinear-sadc-modelling/code/comp-vis.svg" alt=""></div> <p>As can be seen, the performance of the non-linear model is somewhat similar to the linear one. For the <span class=katex ><span class=katex-mathml ><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>θ</mi></mrow><annotation encoding="application/x-tex">\theta</annotation></semantics></math></span><span class=katex-html  aria-hidden=true ><span class=base ><span class=strut  style="height:0.6944em;"></span><span class="mord mathnormal" style="margin-right:0.02778em;">θ</span></span></span></span> Euler angle however, the non-linear effects are quite prominent.</p> <h2 id=implementing_actuator_dynamics ><a href="#implementing_actuator_dynamics" class=header-anchor >Implementing Actuator Dynamics</a></h2> <p>Let&#39;s further complicate matters with our model. So far we have been assuming that the torque applied to the spacecraft from the controllers is instantaneous. In real life however, it sometimes takes the actuator some time to &quot;ramp up&quot; to the desired torque. This is especially true for reaction wheels. For reaction wheels, the first-order transfer function is a reasonable model<sup id="fnref:1"><a href="#fndef:1" class=fnref >[1]</a></sup> for its dynamics:</p> <span class=katex-display ><span class=katex ><span class=katex-mathml ><math xmlns="http://www.w3.org/1998/Math/MathML" display=block ><semantics><mrow><mfrac><mrow><mi>U</mi><mo stretchy=false >(</mo><mi>s</mi><mo stretchy=false >)</mo></mrow><mrow><msub><mi>U</mi><mi>c</mi></msub><mo stretchy=false >(</mo><mi>s</mi><mo stretchy=false >)</mo></mrow></mfrac><mo>=</mo><mfrac><mn>1</mn><mrow><mi>T</mi><mi>s</mi><mo>+</mo><mn>1</mn></mrow></mfrac></mrow><annotation encoding="application/x-tex"> \frac{U(s)}{U_c(s)} = \frac{1}{T s + 1} </annotation></semantics></math></span><span class=katex-html  aria-hidden=true ><span class=base ><span class=strut  style="height:2.363em;vertical-align:-0.936em;"></span><span class=mord ><span class="mopen nulldelimiter"></span><span class=mfrac ><span class="vlist-t vlist-t2"><span class=vlist-r ><span class=vlist  style="height:1.427em;"><span style="top:-2.314em;"><span class=pstrut  style="height:3em;"></span><span class=mord ><span class=mord ><span class="mord mathnormal" style="margin-right:0.10903em;">U</span><span class=msupsub ><span class="vlist-t vlist-t2"><span class=vlist-r ><span class=vlist  style="height:0.1514em;"><span style="top:-2.55em;margin-left:-0.109em;margin-right:0.05em;"><span class=pstrut  style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">c</span></span></span></span><span class=vlist-s >​</span></span><span class=vlist-r ><span class=vlist  style="height:0.15em;"><span></span></span></span></span></span></span><span class=mopen >(</span><span class="mord mathnormal">s</span><span class=mclose >)</span></span></span><span style="top:-3.23em;"><span class=pstrut  style="height:3em;"></span><span class=frac-line  style="border-bottom-width:0.04em;"></span></span><span style="top:-3.677em;"><span class=pstrut  style="height:3em;"></span><span class=mord ><span class="mord mathnormal" style="margin-right:0.10903em;">U</span><span class=mopen >(</span><span class="mord mathnormal">s</span><span class=mclose >)</span></span></span></span><span class=vlist-s >​</span></span><span class=vlist-r ><span class=vlist  style="height:0.936em;"><span></span></span></span></span></span><span class="mclose nulldelimiter"></span></span><span class=mspace  style="margin-right:0.2778em;"></span><span class=mrel >=</span><span class=mspace  style="margin-right:0.2778em;"></span></span><span class=base ><span class=strut  style="height:2.0908em;vertical-align:-0.7693em;"></span><span class=mord ><span class="mopen nulldelimiter"></span><span class=mfrac ><span class="vlist-t vlist-t2"><span class=vlist-r ><span class=vlist  style="height:1.3214em;"><span style="top:-2.314em;"><span class=pstrut  style="height:3em;"></span><span class=mord ><span class="mord mathnormal" style="margin-right:0.13889em;">T</span><span class="mord mathnormal">s</span><span class=mspace  style="margin-right:0.2222em;"></span><span class=mbin >+</span><span class=mspace  style="margin-right:0.2222em;"></span><span class=mord >1</span></span></span><span style="top:-3.23em;"><span class=pstrut  style="height:3em;"></span><span class=frac-line  style="border-bottom-width:0.04em;"></span></span><span style="top:-3.677em;"><span class=pstrut  style="height:3em;"></span><span class=mord ><span class=mord >1</span></span></span></span><span class=vlist-s >​</span></span><span class=vlist-r ><span class=vlist  style="height:0.7693em;"><span></span></span></span></span></span><span class="mclose nulldelimiter"></span></span></span></span></span></span> <p>Where <span class=katex ><span class=katex-mathml ><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>T</mi><mo>&gt;</mo><mn>0</mn></mrow><annotation encoding="application/x-tex">T &gt; 0</annotation></semantics></math></span><span class=katex-html  aria-hidden=true ><span class=base ><span class=strut  style="height:0.7224em;vertical-align:-0.0391em;"></span><span class="mord mathnormal" style="margin-right:0.13889em;">T</span><span class=mspace  style="margin-right:0.2778em;"></span><span class=mrel >&gt;</span><span class=mspace  style="margin-right:0.2778em;"></span></span><span class=base ><span class=strut  style="height:0.6444em;"></span><span class=mord >0</span></span></span></span>. This is a transfer system for the actual actuator output <span class=katex ><span class=katex-mathml ><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>U</mi><mo stretchy=false >(</mo><mi>s</mi><mo stretchy=false >)</mo></mrow><annotation encoding="application/x-tex">U(s)</annotation></semantics></math></span><span class=katex-html  aria-hidden=true ><span class=base ><span class=strut  style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathnormal" style="margin-right:0.10903em;">U</span><span class=mopen >(</span><span class="mord mathnormal">s</span><span class=mclose >)</span></span></span></span> from the controller output <span class=katex ><span class=katex-mathml ><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>U</mi><mi>c</mi></msub><mo stretchy=false >(</mo><mi>s</mi><mo stretchy=false >)</mo></mrow><annotation encoding="application/x-tex">U_c(s)</annotation></semantics></math></span><span class=katex-html  aria-hidden=true ><span class=base ><span class=strut  style="height:1em;vertical-align:-0.25em;"></span><span class=mord ><span class="mord mathnormal" style="margin-right:0.10903em;">U</span><span class=msupsub ><span class="vlist-t vlist-t2"><span class=vlist-r ><span class=vlist  style="height:0.1514em;"><span style="top:-2.55em;margin-left:-0.109em;margin-right:0.05em;"><span class=pstrut  style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">c</span></span></span></span><span class=vlist-s >​</span></span><span class=vlist-r ><span class=vlist  style="height:0.15em;"><span></span></span></span></span></span></span><span class=mopen >(</span><span class="mord mathnormal">s</span><span class=mclose >)</span></span></span></span>.</p> <p>Thus, to simulate actuator dynamics, we can introduce a first-order filter to the simulation using the <code>FirstOrder</code> block from the <code>ModelingToolkit.jl</code> standard library. This block is then connected between the controller output and the spacecraft torque input:</p> <pre><code class="julia hljs">actuator_T = <span class=hljs-number >0.05</span>
<span class=hljs-meta >@named</span> ad_ϕ = B.FirstOrder(T=actuator_T)
<span class=hljs-meta >@named</span> ad_θ = B.FirstOrder(T=actuator_T)
<span class=hljs-meta >@named</span> ad_ψ = B.FirstOrder(T=actuator_T)

sc_ad_eqs = [
    connect(setpoint_sca.output, feedback_ϕ.input1),
    connect(feedback_ϕ.output, ctrl_ϕ.err_input),
    connect(ctrl_ϕ.ctr_output, ad_ϕ.input),
    connect(ad_ϕ.output, sc.Mx),
    connect(sc.phi_x, feedback_ϕ.input2),

    connect(setpoint_sca.output, feedback_θ.input1),
    connect(feedback_θ.output, ctrl_θ.err_input),
    connect(ctrl_θ.ctr_output, ad_θ.input),
    connect(ad_θ.output, sc.My),
    connect(sc.phi_y, feedback_θ.input2),

    connect(setpoint_sca.output, feedback_ψ.input1),
    connect(feedback_ψ.output, ctrl_ψ.err_input),
    connect(ctrl_ψ.ctr_output, ad_ψ.input),
    connect(ad_ψ.output, sc.Mz),
    connect(sc.phi_z, feedback_ψ.input2),
]

<span class=hljs-meta >@named</span> sc_ad_model = ODESystem(sc_ad_eqs, t; systems = [
    sc, setpoint_sca,
    feedback_ϕ, ctrl_ϕ, torque_ϕ,
    feedback_θ, ctrl_θ, torque_θ,
    feedback_ψ, ctrl_ψ, torque_ψ,
    ad_ϕ, ad_θ, ad_ψ
])

sc_ad_sys = structural_simplify(sc_ad_model)

sc_ad_prob = ODEProblem(sc_ad_sys, [], (<span class=hljs-number >0</span>, <span class=hljs-number >2.5</span>), [])
sc_ad_sol = solve(sc_ad_prob)</code></pre> <p>Let&#39;s now visualize the Euler angles over time of this simulation, and compare these results to the two previous models:</p> <pre><code class="julia hljs">fig3 = Figure(resolution=(<span class=hljs-number >1000</span>,<span class=hljs-number >500</span>))
ax31 = Axis(fig3[<span class=hljs-number >1</span>,<span class=hljs-number >1</span>], xlabel=<span class=hljs-string >&quot;Time (s)&quot;</span>, ylabel=<span class=hljs-string >&quot;Angle (°)&quot;</span>, title=<span class=hljs-string >&quot;ϕ&quot;</span>)

ad_interp = sc_ad_sol(times)

lines!(ax31, times, rad2deg.(ad_interp[sc.ϕ]))
lines!(ax31, times, rad2deg.(nonlinear_interp[sc.ϕ]), linestyle=:dot)
lines!(ax31, times, rad2deg.(linear_interp[scl.Ix.phi]), linestyle=:dash)

ax32 = Axis(fig3[<span class=hljs-number >1</span>,<span class=hljs-number >2</span>], xlabel=<span class=hljs-string >&quot;Time (s)&quot;</span>, title=<span class=hljs-string >&quot;θ&quot;</span>)

lines!(ax32, times, rad2deg.(ad_interp[sc.θ]))
lines!(ax32, times, rad2deg.(nonlinear_interp[sc.θ]), linestyle=:dot)
lines!(ax32, times, rad2deg.(linear_interp[scl.Iy.phi]), linestyle=:dash)

ax33 = Axis(fig3[<span class=hljs-number >1</span>,<span class=hljs-number >3</span>], xlabel=<span class=hljs-string >&quot;Time (s)&quot;</span>, title=<span class=hljs-string >&quot;ψ&quot;</span>)

lines!(ax33, times, rad2deg.(ad_interp[sc.ψ]), label=<span class=hljs-string >&quot;Actuator Dynamics&quot;</span>)
lines!(ax33, times, rad2deg.(nonlinear_interp[sc.ψ]), linestyle=:dot, label=<span class=hljs-string >&quot;Non-linear&quot;</span>)
lines!(ax33, times, rad2deg.(linear_interp[scl.Iz.phi]), linestyle=:dash, label=<span class=hljs-string >&quot;Linear&quot;</span>)

fig3[<span class=hljs-number >2</span>, <span class=hljs-number >2</span>] = Legend(
    fig3, ax33, <span class=hljs-string >&quot;Model&quot;</span>, framevisible=<span class=hljs-literal >false</span>, orientation=:horizontal, tellwidth=<span class=hljs-literal >false</span>
)

fig3</code></pre> <div class=im-100 ><img src="/starcoffee/assets/posts/nonlinear-sadc-modelling/code/comp-vis2.svg" alt=""></div> <p>With every iteration upon the linear model we implement, the performance of our controllers worsen, but we get closer to real-life behaviour.</p> <h2 id=wrapping_up ><a href="#wrapping_up" class=header-anchor >Wrapping Up</a></h2> <p>Thanks for reading, I hope this post was insightful. I&#39;ve been having a great time learning <code>ModelingToolkit.jl</code> more, it really is an amazing package. I&#39;m planning to keep learning it more and implementing more spacecraft attitude dynamics and controls stuff using it. I&#39;m planning on implementing a lot of this work into <a href="https://michaszj.github.io/starcoffee/posts/satellite-analysis-toolkit/">SAT</a>, so expect some updates on that project soon. More posts soon, until next time.</p> <h2 id=references ><a href="#references" class=header-anchor >References</a></h2> <table class=fndef  id="fndef:1"> <tr> <td class=fndef-backref ><a href="#fnref:1">[1]</a> <td class=fndef-content >A.H.J. de Ruiter, C.J. Damaren, J.R. Forbes, &quot;Routh’s Stability Criterion,&quot; in <em>Spacecraft Dynamics and Control: An Introduction</em>, 1st Edition. West Sussex, UK: John Wiley &amp; Sons Ltd., 2013. </table> <div class=page-foot > <a href="http://creativecommons.org/licenses/by-sa/4.0/">CC BY-SA 4.0</a> <a href="https://michaszj.github.io/">Michal Jagodzinski</a>. Last modified: May 18, 2023. <br>Website built with <a href="https://github.com/tlienart/Franklin.jl">Franklin.jl</a> and the <a href="https://julialang.org">Julia programming language</a>. </div> </div> </div> </div> <script src="/starcoffee/libs/highlight/highlight.min.js"></script> <script>hljs.highlightAll();hljs.configure({tabReplace: ' '});</script> <label for=sidebar-checkbox  class=sidebar-toggle ></label>